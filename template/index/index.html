<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/foot.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../icon/img_font.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<title>首页</title>
		<style>
			#marqee_bar {
				width: 100%; 
				height: 150px;
				background: white;
			}
			
			.mui-bar-tab {
				border: 1px solid #E6E6E6;
			}
			
			body {
				padding-bottom: 55px;
			}
			
			#scoll_msg {
				width: 100%;
				height: 100px;
				max-height: 100px;
				background: white;
				overflow: hidden;
			}
			.mui-btn-link{
				color: #fff;
				padding-top: 12px;
				padding-bottom: 12px;
			}
			.img_z {
				height: 16px;
			}

			.refuse{
				width: 100%;
				height: 100%;
				position: fixed;
				top: 0;
				left: 0;
				background: rgba(0,0,0,0.7);
				z-index: 99;
			}
			.refuse_cont{
				width: 80%;
				height: auto;
				position: absolute;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
				display: inline-table;
				background: #fff;
				border-radius: 10px;
				margin: auto;
			}
			.refuse_cont .title{
				text-align: center;
				border-bottom: 1px solid #ccc;
				color: #0098E6;
				line-height: 44px !important;
			}
			.refuse_cont p{
				text-align: left;
				line-height: 20px;
				margin-top: 5px ;
			}
			.refuse_cont .refuse_bot{
				margin-top: 10px;
				width: 100%;
			}
			.refuse_cont .refuse_bot button{
				float: left;
				width: 50%;
				height: 44px;
				border-radius: 0;
				border-bottom-left-radius: 10px;
				border-bottom-right-radius: 10px;
				border: none;
				border-top: 1px solid #ccc;
				font-size: 18px;
				color: #666;
			}
			.input_pwd{
				padding: 20px 30px;
			}
			.input_pwd p{
				font-size: 16px;
				line-height: 28px;
			}
			#my-vou-close{
				border-right: 1px solid #ccc;
				border-bottom-right-radius: 0px;
			}
			#my-vou-btn{
				color: #0098e6;
			}
			#more{
				margin-right: 10px;
				color: #666;
			}
			.have_msg{
				width: 7px;
				height: 7px;
				border-radius: 50%;
				background: #f00;
				display: none;
				position: absolute;
				top: 10px;
				right: 25px;
			}
			.have_des{
				width: 7px;
				height: 7px;
				border-radius: 50%;
				background: #f00;
				/*float: left;*/
				display: none;
			}

		</style>
	</head>

	<body>

		<div class="padding_55" id="home_page">
			<div class="mui-conten home_bar">
				<div id="header" class="index_bar mui-bar-nav">
					<h1 class="mui-title white">共生网</h1>
					<button class="mui-btn-link mui-pull-right" id="explain">补贴攻略</button>
				</div>
				<div class="icon_btn" id="index_bar" style="display: none;">
					<div class="qrcode fl" id="saoyisao">
						<img src="../../img/home/qrcode.png" class="btn_img" />
						<p class="clear">扫一扫</p>
					</div>
					<hr class="v_homeline" id="line" />
					<div class="receivables fl" id="buy_vou">
						<img src="../../img/home/buy.png" class="btn_img" />
						<p class="clear">购买消费券</p>
					</div>
					<hr class="v_homeline2" id="line2" />
					<div class="buy fl" id="buy_v">
						<img src="../../img/home/bus_want.png" class="btn_img" />
						<p class="clear">申请补贴</p>
					</div>
					<!--<hr class="v_shopline3" id="line3"/>
					<div class="s_secode fl" id="m_code" style="display: none;">
						<img src="../../img/home/bus_want.png" class="btn_img" />
						<p class="clear">我的收款码</p>
					</div>-->
				</div>
				<div class="icon_btn" id="shop_bar" style="display: none">
					<div class="s_qrcode fl" id="bus_saoyisao">
						<img src="../../img/home/qrcode.png" class="btn_img" />
						<p class="clear">扫一扫</p>
					</div>
					<hr class="v_shopline" />
					<div class="s_receivables fl" id="bus_buy_vou">
						<img src="../../img/home/buy.png" class="btn_img" />
						<p class="clear">购买消费券</p>
					</div>
					<hr class="v_shopline2" />
					<div class="s_buy fl" id="bus_buy_v">
						<img src="../../img/home/bus_want.png" class="btn_img" />
						<p class="clear">申请补贴</p>
					</div>
					<hr class="v_shopline3" />
					<div class="s_secode fl" id="my_code">
						<img src="../../img/home/secode.png" class="btn_img" />
						<p class="clear">我的收款码</p>
					</div>
				</div>
			</div>
			<!--功能结束-->
			<!--我的报销和收益-->
			<div class="common_title fl">
				<img src="../../img/home/acount_img.png" class="fl home_img" />
				<span class="common_txt fl">我的补贴</span>
			</div>
			<div class="group_bar" id="select_type">
				<ul class="group_ul">
					
					<li class="no_group" id="no_group">
						<img src="../../img/home/nogroup.png" class="group_img" />
						<span class="goto" value="0">未排队</span>
						<em class="have_des no_des"></em>
						<span><span class="gr_size " id="not_queued_count">0</span>
						<span>张</span>
						</span>
						<img src="../../img/default/right.png" class="rightgroupimg" />
					</li>
					<li class="in_group" id="in_group">
						<img src="../../img/home/ingroup.png" class="group_img" />
						<span class="goto" value="1">排队中</span>
						<em class="have_des in_des"></em>
						<span>
							<span class="gr_size" id="wait_count">0</span>
						<span>张</span>
						</span>
						<img src="../../img/default/right.png" class="rightgroupimg" />
					</li>

					<li class="over_group" id="over_group">
						<img src="../../img/home/finnish.png" class="group_img" />
						<span class="goto" value="2">已完成</span>
						<em class="have_des over_des"></em>
						<span><span class="gr_size " id="done_count">0</span>
						<span>张</span>
						</span>
						<img src="../../img/default/right.png" class="rightgroupimg" />
					</li>
				</ul>
			</div>
			<div id="banner" class="banner_bar">
				<div class="db">
					<ul class="banner_img">
						<!--<li>
							<a href="#"><img src="../../img/home/banner.png" id="banner0" class="ban_img" /></a>
						</li>
						<li>
							<a href="#"><img src="../../img/home/banner.png" id="banner1" class="ban_img" /></a>
						</li>
						<li>
							<a href="#"><img src="../../img/home/banner.png" id="banner2" class="ban_img" /></a>
						</li>-->
					</ul>
				</div>
				<div class="hb">
					<ul class="point">

					</ul>
				</div>
			</div>

			<div class="common_title fl">
				<img src="../../img/home/info.png" class="fl home_img" />
				<span class="common_txt fl">实时动态</span>
				<a href="javascript:;" class="common_txt fr" id="more">更多</a>
			</div>

			<!--<marquee direction="up" scrollamount="2" id="marqee_bar" style="position: relative;">-->
			<div id="scoll_msg">
				<ul id="scoll_content">

				</ul>
			</div>
			<!--</marquee>-->
		</div>

		<div class="refuse" id="my-vou" style="display: none;">
			<div class="refuse_cont">
				<div class="pay_title">
					<div class="input_pwd">
						<p>只有商家才可购买消费券，是否升级为商家？</p>
					</div>

				</div>
				<div class="refuse_bot">
					<button id="my-vou-close">取消</button>
					<button id="my-vou-btn">立即升级</button>
				</div>
			</div>
		</div>-->
		<div class="refuse" id="my-vou" style="display: none;">
			<div class="refuse_cont">
				<div class="pay_title">
					<div class="input_pwd">
						<p>只有商家才可购买消费券，是否升级为商家？</p>
					</div>
				</div>
				<div class="refuse_bot">
					<button id="my-vou-close">取消</button>
					<button id="my-vou-btn">立即升级</button>
				</div>
			</div>
		</div>
		<nav class="navlist">
			<a id="index" data="index" class="active mui-icon iconfont">
				<img src="../../img/navigation/check_home.png" alt="" class="img_z" />
				<p>首页</p>
			</a>
			<a id="merchant" data="city_shop" class="iconfont mui-icon">
				<img src="../../img/navigation/shop.png" alt="" class="img_z" />
				<p>商家</p>
			</a>
			<a id="message" data="info_system_sub" class="iconfont mui-icon">
				<img src="../../img/navigation/msg.png" alt="" class="img_z" />
				<span class="have_msg"></span>
				<p>消息</p>
			</a>
			<a id="me" data="mine" class="iconfont mui-icon">
				<img src="../../img/navigation/my.png" alt="" class="img_z" />
				<p>我的</p>
			</a>
		</nav>
	</body>
	<script src="../../js/jquery-3.1.0.min.js" type="text/javascript"></script>
	<script src="../../js/mui.min.js" type="text/javascript"></script>
	<script src="../../js/common.js" type="text/javascript"></script>
	<script src="../../js/TouchSlide.1.1.js" type="text/javascript"></script>
	<script type="text/javascript" src="../../js/scroll.js"></script>
	<script type="text/javascript">
		mui.init();
		
		
		
		
		$(function() {

			$.ajax({
				type: "post",
				data: data = {
					"OPERATE_TYPE": "10098",
					"BEGIN": "0",
					"SIZE": "50"
				},
				url: booking.constants.api_domain,
				async: true,
				success: function(data) {
					if(data.RESULTCODE == "0") {
						console.log(JSON.stringify(data));
						var infolist = data.RESULTLIST.result;
						var info_list = '';
						for(var i = 0; i < infolist.length; i++) {
							info_list += '<li class="mui-table-view-cell">';
							info_list += '<div class="info_pos">';
							info_list += '<img src="../../img/home/info_msg.png" class="info_icon fl" />';
							info_list += '<p class="msg_time"><span class="in_day">' + dataUtil(infolist[i].create_time) + '</span><span class="in_phone">用户：' + replacePhone(infolist[i].username) + '</span><span class="out_money">'+infolist[i].des + infolist[i].amount + '元</span></p>';
							info_list += '</div></li>';
						}
						$("#scoll_content").append(info_list);
						//$("#scoll_msg").css({"height":infolist.length*50 - 1 +"px","maxheight":"149px"})
						myScroll();
					}
				},
				error: function(result) {

				}
			});
		})
		
		
		
		var auid = localStorage.getItem("auid");
		//		localStorage.removeItem("auid");
		var my_shop_info = null;
		var type = 1;
		var isReal = false;
		mui.plusReady(function() {
			var isLogin = null;
			mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {
					console.log(JSON.stringify(result))
					if(result.RESULTCODE == 0) {
							
						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							isLogin = 0;
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						isLogin = 0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						return;

					}
				});
			if(isLogin ===0){
				return;
			}
			//Android双击home键退出应用
			var first = null;
			mui.back = function() {
				if(!first) {
					first = new Date().getTime();
					mui.toast('再按一次退出程序');
					setTimeout(function() {
						first = null;
					}, 1000);
				} else {
					if(new Date().getTime() - first < 1000) {
						plus.runtime.quit();
					}
				}
			};

			plus.webview.currentWebview().setStyle({
				scrollIndicator: 'none'
			});

			mui(".navlist").on("tap", "a", function() {
				var id = $(this).attr("id");
				var data = $(this).attr("data");
				var url = "../" + id + "/" + data + ".html";
				if(id == "index" ){
					return;
				}else {
					booking.closeAndOpenNewWindow(url, id);
				}

			});
			mui.app_request('POST', {
				"OPERATE_TYPE": "10003",
				"BEGIN": "0",
				"SIZE": "10"
			}, function(data) {
				if(data.RESULTCODE == "0") {
					var imgpic = data.RESULTLIST.result;
					var html = '';
					var htmls = '';
					for(var i = 0; i < imgpic.length; i++) {
						html += '<li>';
						html += '<a href="' + imgpic[i].click_url + '"><img src="' +
							booking.constants.ip + imgpic[i].url + '" class="ban_img" data-url="' + imgpic[i].click_url + '" data-type="' + imgpic[i].click_type + '" /></a>';
						html += '</li>';
						htmls += '<li></li>';
					}
					$(".banner_img").html(html);
					$(".point").html(htmls);
					banner();
					mui(".banner_img").on("tap", "li", function() {
						var img = $(this).find("img");
						var type = img.attr("data-type");
						var url = img.attr("data-url");
						if(type == 0) {
							return;
						} else if(type == 1) {
							//mui.openWindow();
							mui.openWindow({
								url: url,
							});
						} else if(type == 2) {
							plus.runtime.openURL(url);
						}
					})

				}
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					mui.toast(result.DESCRIPTION)
				}
			});
			
			//判断是否登录
			//if(auid) {
			//获取商户信息
			mui.app_request('POST', {
				"OPERATE_TYPE": "10023",
				"AUTH_ID": auid
			}, function(data) {
				if(data.RESULTCODE == "0") {
					my_shop_info = data.RESULTLIST.my_shop_info;
					var my_bz_info = data.RESULTLIST.my_bz_info;
					type = data.RESULTLIST.user_type;
					if(data.RESULTLIST.ida_auth == 1){
						isReal = true;
					}
					if(!mui.isnull(my_bz_info.wait_count)) {
						$("#wait_count").html(my_bz_info.wait_count);
					}
					if(!mui.isnull(my_bz_info.not_queued_count)) {
						$("#not_queued_count").html(my_bz_info.not_queued_count);
					}
					if(!mui.isnull(my_bz_info.done_count)) {
						$("#done_count").html(my_bz_info.done_count);
					}
					if(type == 3) {
						$("#shop_bar").show();
					} else {
						$("#index_bar").show();
					}

				}
				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					mui.toast(result.DESCRIPTION);
				} else {
					mui.toast("系统异常，请重试1");
				}
			})
			
			
			mui.app_request_async('POST', {
				"OPERATE_TYPE": "20001", 
				"AUTH_ID": auid
			}, function(data) {
				console.log("测试："+JSON.stringify(data));
				var bzList = localStorage.getItem("bzList");
				var bzinGroup = localStorage.getItem("bzinGroup");
				var bzFinish = localStorage.getItem("bzFinish");
				var message = localStorage.getItem("message");
				console.log(bzList+'||'+data.bzList)
				if(mui.isnull(bzList)){
					localStorage.setItem("bzList",data.bzList);
				}else{
					if( data.bzList > bzList ){
						$(".no_des").css("display","inline-block");
						//alert(1);
					}
				}
				if(mui.isnull(bzinGroup)){
					localStorage.setItem("bzinGroup",data.bzinGroup);
				}else{
					if( data.bzinGroup > bzinGroup ){
						$(".in_des").css("display","inline-block");
						//alert(2);
					}
				}
				if(mui.isnull(bzFinish)){
					localStorage.setItem("bzFinish",data.bzFinish);
				}else{
					if( data.bzFinish > bzFinish ){
						$(".over_des").css("display","inline-block");
						//alert(3);
					}
				}
				if(mui.isnull(message)){
					localStorage.setItem("message",data.message);
				}else{
					if( data.message > message ){
						$(".have_msg").show();
					}
				}
				return;
			}, function(result) {
				console.log("测试："+JSON.stringify(result));
				return;
			})
			//跳转我要报账页面
			document.getElementById("buy_v").addEventListener('tap', function() {
				//				mui.openWindow({
				//					id: 'reimbur',
				//					url: 'reimbur_me.html',
				//					extras: {
				//						type: 0,
				//						backId: "reimbur_me"
				//					}
				//				});
				var attrValue = {
					type: 0,
					backId: "index"
				}
				booking.closeAndOpenNewWindowHaveAttr(
					'reimbur_me.html',
					'reimbur_me',
					attrValue
				)
			});
			//更多实时动态
			document.getElementById("more").addEventListener('tap', function() {
				booking.closeAndOpenNewWindow(
					'dynamic.html',
					'dynamic'
				)
			}); 
			//跳转我要报账页面
			document.getElementById("bus_buy_v").addEventListener('tap', function() {
				//				mui.openWindow({
				//					id: 'reimbur',
				//					url: 'reimbur_me.html',
				//					extras: {
				//						type: 0,
				//						backId: "reimbur_me"
				//					},
				//					createNew:true
				//					
				//				});
				var attrValue = {
					type: 0,
					backId: "index"
				}
				booking.closeAndOpenNewWindowHaveAttr(
					'reimbur_me.html',
					'reimbur_me',
					attrValue
				)
			});

			//跳转我要报账页面
			document.getElementById("my_code").addEventListener('tap', function() {
				//				mui.openWindow({
				//					id: 'myPayCode',
				//					url: 'myPayCode.html',
				//				});
				booking.closeAndOpenNewWindow(
					'myPayCode.html',
					'myPayCode'
				)
			});
			//跳转我要补贴说明
			document.getElementById("explain").addEventListener('tap', function() {
				booking.closeAndOpenNewWindow(
					'.././static_url/sale_cont.html',
					'sale_cont'
				)
			});
			//购买凭证
			document.getElementById("buy_vou").addEventListener('tap', function() {
				if(type == 1) {
					$("#my-vou").show();
					//mui.toast("只有商家才能购买消费券");
					return;
				}
				booking.closeAndOpenNewWindow(
					'../business/buy_voucher.html',
					'buy_voucher'
				)
			});
			document.getElementById("my-vou-close").addEventListener('tap', function() {
				$("#my-vou").hide();
			});
			document.getElementById("my-vou-btn").addEventListener('tap', function() {
				$("#my-vou").hide();
				var attrd={
					"isreal":isReal
				}
				booking.closeAndOpenNewWindowHaveAttr(
					'../me/mar_cert.html',
					'mar_cert.html',
					attrd
				)
			});

			//购买凭证
			document.getElementById("bus_buy_vou").addEventListener('tap', function() {
				if(type == 1) {
					$("#my-vou").show();
					//mui.toast("只有商家才能购买消费券");
					return;
				}
				//				mui.openWindow({
				//					id: 'buy_voucher',
				//					url: '../business/buy_voucher.html',
				//					createNew:true
				//				});
				booking.closeAndOpenNewWindow(
					'../business/buy_voucher.html',
					'buy_voucher'
				)
			});
			//跳转我的报账记录页面
			mui("#select_type").on("tap", "li", function() {
				var type = this.querySelector(".goto").getAttribute("value");
				//mui.app_refresh("my_accountss");
				//				mui.openWindow({
				//					url: "my_accountss.html",
				//					id: "my_accountss",
				//					extras: {
				//						status: type,
				//						backId: "index"
				//					},
				//					createNew:true
				//				});
				var attrValue = {
					status: type,
					backId: "index"
				}
				booking.closeAndOpenNewWindowHaveAttr(
					'my_accountss.html',
					'my_accountss',
					attrValue
				)
			})

			//跳转扫一扫页面
			document.getElementById("saoyisao").addEventListener('tap', function() {
				mui.openWindow({
					id: 'barcode',
					url: 'barcode.html'
				});
			});
			//跳转扫一扫页面
			document.getElementById("bus_saoyisao").addEventListener('tap', function() {
				mui.openWindow({
					id: 'barcode',
					url: 'barcode.html'
				});
			});
		});
		//	图片轮播
		function banner() {
			TouchSlide({
				slideCell: "#banner",
				titCell: ".hb ul",
				mainCell: ".db ul",
				effect: "leftLoop",
				autoPage: true,
				autoPlay: true,
			});
		}

		function dataUtil(time_data) {
			var date = new Date(time_data.replace(/-/g, "/"));
			var month = date.getMonth() + 1;
			var day = date.getDate();
//			var hour = date.getHours();
//			var minutes = date.getMinutes();
//			if(hour <10){
//				hour = "0"+hour;
//			}
//			if(minutes < 10){
//				minutes = "0"+minutes;
//			}
			return month + "月" + day + "日" //+"  "+hour+":"+minutes;
		}

		function myScroll() {
			$('#scoll_msg').myScroll({
				speed: 40, //数值越大，速度越慢
				rowHeight: 50 //li的高度
			});
		}

		function timeUtil(time) {
			var date = new Date(time.replace(/-/g, "/"));
			var hour = date.getHours();
			var minutes = date.getMinutes();
			if(minutes < 10) {
				minutes = "0" + minutes;
			}
			return hour + ":" + minutes;
		}

		function gogo() {
			var result = plus.storage.getItem('result');
			var setType = plus.storage.getItem("setType");
			plus.storage.removeItem("setType");
			if(result.indexOf("http") != -1) {
				plus.runtime.openURL(result);
				return;
			};
			console.log(result);
			if(setType) {
				if(!mui.os.ios) {
					result = result.substring(1, result.length - 1)
				}
			}

			result = eval('(' + result + ')');
			if(mui.isnull(result.user_id)) {
				mui.toast("无法验证的二维码.")
				return;
			};
			if(mui.isnull(result.shop_id)) {
				mui.toast("无法验证的二维码.")
				return;
			}

			mui.openWindow({
				id: "i_wllpay",
				url: "i_wllpay.html",
				extras: {
					result: result,
					backId: "index"
				},
				createNew: true
			})
		}
	</script>

</html>