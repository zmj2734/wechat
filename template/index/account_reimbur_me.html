<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我要报账</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<script src="../../js/jquery-3.1.0.min.js" type="text/javascript"></script>
		<script src="../../js/mui.min.js" type="text/javascript"></script>
		<script src="../../js/common.js" type="text/javascript"></script>
		<script type="text/javascript" src="../../js/exif.js"></script>
		<script type="text/javascript" src="../../js/upload.util.js"></script>
		<style type="text/css">
			.mui-icon-info {
				font-size: 16px !important;
			}
			
			.mui-table-view-cell .money {
				margin-right: 10px;
			}
		</style>
		<script type="text/javascript">
			mui.init({
				swipeBack: true
			});

			var auid = localStorage.getItem("auid");
			var have_num = 0;
			var INVOICE_ID = null;
			var win = null;
			var list = null;
			var CERTIFICATE_ID = null;
			var re_submit = null;
			var daysynum = null;
			var isLogin = null;
			mui.plusReady(function() {

				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {

					if(result.RESULTCODE == 0) {

						if(result.RESULTLIST.is_login == 1) {
							isLogin = 1;
							return;
						} else {
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						isLogin = 1;
						return;

					}
				});
				if(isLogin === 1) {

					win = plus.webview.currentWebview();
					CERTIFICATE_ID = win.CERTIFICATE_ID;
					re_submit = win.re_submit;
					INVOICE_ID = win.INVOICE_ID;

					//获得用户的凭证列表 
					mui.app_request('POST', {
						"OPERATE_TYPE": "10025",
						"AUTH_ID": auid,
						"INVOICE_ID": INVOICE_ID
					}, function(data) {
						if(data.RESULTCODE == "0") {
							list = data.RESULTLIST.result;

							if(list.length == 0) {
								$("#no_use").html("你没有可使用的消费券");
								$("#kaiguan").hide();
							} else {
								for(var i = 0; i < list.length; i++) {
									var des = list[i].des;
									des = parseInt(des.substring(0, 1));

									if(8 == des) {
										if(list[i].num > 0) {
											$("#no_use").html("可使用消费券" + list[i].num + "张");
											$("#kaiguan").show();
											have_num = list[i].num;
											break;
										}
									} else {
										$("#no_use").html("你没有可使用的消费券");
										$("#kaiguan").hide();
									}
								}
							}
						}
						return;
					}, function(result) {
						mui.toast("系统异常，请重试");
					});
					//获取计算当日剩余补贴金额
					mui.app_request('POST', {
						"OPERATE_TYPE": "20006",
						"AUTH_ID": auid
					}, function(data) {

						if(data.RESULTCODE == "0") {
							var daynum = data.RESULTLIST.result;
							if(mui.isnull(daynum)) {
								daynum = 0;
							}
							daysynum = 2000 - parseInt(daynum);
							$("#amonut_sy").html(daysynum.toFixed(2))
						}
						return;
					}, function(result) {
						mui.toast("系统异常，请重试");
					});

					mui.app_request('POST', {
						"OPERATE_TYPE": "10065",
						"AUTH_ID": auid,
						"INVOICE_ID": INVOICE_ID
					}, function(data) {
						if(data.RESULTCODE == "0") {
							var reuslt = data.RESULTLIST.invoice;

							$("#fpImage").attr("src", booking.constants.ip + reuslt.file_url);
							var total = parseFloat(reuslt.amount) - parseFloat(reuslt.used_amount);
							$("#fp_money").val(total);
						}
						return;
					}, function(result) {

						if(result.RESULTCODE == "-1") {
							mui.toast(result.DESCRIPTION);
							return;
						}
						mui.toast("系统异常，请重试");
						return;
					});

					//获取平台开放的档次
					//				mui.app_request('POST', {
					//					"OPERATE_TYPE": "10014",
					//				}, function(data) {
					//					if(data.RESULTCODE == "0") {
					//						var _html = "";
					//						var result = data.RESULTLIST.result;
					//						for(var i = 0; i < result.length; i++) {
					//							var des = result[i].des;
					//							des = des.substring(0, 1);
					//							if(result[i].b_type=="1"){
					//									_html += "<li>";
					//									_html += '<div class="dis_img fl no_dis des_img_no">';
					//									_html += '<img class="des_imgs" src="../../img/default/icon-des-08.png"/>';
					//									_html += '<input type="hidden" value="' + result[i].b_type + '"/>'
					//									_html += '</div></li>'; 
					//								}else if(result[i].b_type=="2"){
					//									_html += "<li>";
					//									_html += '<div class="dis_img fl no_dis des_img_no">';
					//									_html += '<img class="des_imgs" src="../../img/default/icon-des-07.png"/>';
					//									_html += '<input type="hidden" value="' + result[i].b_type + '"/>'
					//									_html += '</div></li>'; 
					//								}else if(result[i].b_type=="3"){
					//									_html += "<li>";
					//									_html += '<div class="dis_img fl no_dis des_img_no">';
					//									_html += '<img class="des_imgs" src="../../img/default/icon-des-06.png"/>';
					//									_html += '<input type="hidden" value="' + result[i].b_type + '"/>'
					//									_html += '</div></li>'; 
					//								}else if(result[i].b_type=="4"){
					//									_html += "<li>";
					//									_html += '<div class="dis_img fl no_dis des_img_no">';
					//									_html += '<img class="des_imgs" src="../../img/default/icon-des-05.png"/>';
					//									_html += '<input type="hidden" value="' + result[i].b_type + '"/>'
					//									_html += '</div></li>'; 
					//								}
					//							
					//						}
					//						$("#dangci").html(_html);
					//						mui("#dangci").on("tap", ".yes_dis", function() {
					//							$("input").blur();
					//							$(".dis_img").removeClass("change_bgimg");
					//							$(this).addClass('change_bgimg');
					//							$(".art_text").addClass("default");
					//							$(this).find("p").removeClass("default");
					//							circle();
					//						})
					//					}
					//					return;
					//				}, function(result) {
					//					mui.toast("系统异常，请重试");
					//				});

					//下一步
					document.getElementById("next").addEventListener('tap', function() {
						this.setAttribute('disabled', 'disabled');
						//报账金额
						var BZ_AMOUNT = $("#bz_money").val();
						var TOTAL_AMOUNT = $("#fp_money").val();
						if(mui.isnull(BZ_AMOUNT)) {
							document.getElementById("next").removeAttribute('disabled');
							mui.toast("请输入补贴金额");
							return;
						}
						if(BZ_AMOUNT % 100 != 0 || BZ_AMOUNT == 0) {
							mui.toast('补贴金额必须为100的倍数且不能为0');
							remDisabled("next");
							return;
						}
						var VOUCHER_TYPE = 1;
						if(mui.isnull(VOUCHER_TYPE)) {
							document.getElementById("next").removeAttribute('disabled');
							mui.toast("请选择报账档次");
							return;
						}
						if($("#has_banlance").parent('div').hasClass('mui-active')) {
							var BAN_ACOUNT = 0;
							TOTAL_AMOUNTS = parseInt(TOTAL_AMOUNT) + parseInt(BAN_ACOUNT);
							TOTAL_AMOUNTS = parseInt(TOTAL_AMOUNTS);

							if(BZ_AMOUNT > TOTAL_AMOUNTS) {
								mui.toast('补贴金额不能大于发票金额');
								remDisabled("next");
								return;
							}
							remDisabled("next");
						} else {
							BZ_AMOUNT = parseInt(BZ_AMOUNT);
							if(BZ_AMOUNT > TOTAL_AMOUNT) {
								mui.toast('补贴金额不能大于发票金额');
								remDisabled("next");
								return;
							}
							remDisabled("next");
						}
						var USE_BALANCE = 0;
						//					if($("#balan").hasClass("mui-active")) {
						//						USE_BALANCE = 1
						//					}

						if($("#handle").parent("div").hasClass("mui-active")) {
							if(re_submit == 1) {
								mui.app_request('POST', {
									"OPERATE_TYPE": "10036",
									"AUTH_ID": auid, //localStorage.getItem("auid")
									"CERTIFICATE_ID": CERTIFICATE_ID,
									"BZ_AMOUNT": BZ_AMOUNT,
									"VOUCHER_TYPE": VOUCHER_TYPE,
									"USE_BALANCE": USE_BALANCE,
									"INVOICE_ID": INVOICE_ID,
									"USE_VOUCHER": 1,
								}, function(data) {

									if(data.RESULTCODE == "0") {
										document.getElementById("next").removeAttribute('disabled');
										mui.toast("操作成功")
										mui.openWindow("my_accountss.html", "my_accountss");
										return;
									}
									document.getElementById("next").removeAttribute('disabled');
								}, function(result) {
									document.getElementById("next").removeAttribute('disabled');
									if(result.RESULTCODE == "-1") {
										mui.toast(result.DESCRIPTION);
										return;
									} else {
										mui.toast("系统异常，请重试");
										return;
									}
								});
							} else {
								if(have_num * 100 < BZ_AMOUNT) {
									document.getElementById("next").removeAttribute('disabled');
									mui.toast("您的消费券不足");
									return;
								}
								mui.app_request('POST', {
									"OPERATE_TYPE": "10027",
									"AUTH_ID": auid, //localStorage.getItem("auid")
									"BZ_AMOUNT": BZ_AMOUNT,
									"VOUCHER_TYPE": VOUCHER_TYPE,
									"USE_BALANCE": USE_BALANCE,
									"INVOICE_ID": INVOICE_ID,
									"USE_VOUCHER": 1,
								}, function(data) {

									if(data.RESULTCODE == "0") {
										document.getElementById("next").removeAttribute('disabled');
										mui.toast("操作成功")
										mui.openWindow("my_accountss.html", "my_accountss");
										return;
									}
									document.getElementById("next").removeAttribute('disabled');
								}, function(result) {
									document.getElementById("next").removeAttribute('disabled');
									if(result.RESULTCODE == "-1") {
										mui.toast(result.DESCRIPTION);
										return;
									} else {
										mui.toast("系统异常，请重试");
										return;
									}
								});
							}
						} else {
							if(re_submit == 1) {

								document.getElementById("next").removeAttribute('disabled');
								var ss = plus.webview.getWebviewById("findpeople");
								if(ss) {
									plus.webview.close(ss);
								}
								//							mui.openWindow({
								//								id: 'findpeople',
								//								url: 'findpeople.html',
								//								extras: {
								//									"CERTIFICATE_ID": CERTIFICATE_ID,
								//									"re_submit": re_submit,
								//									"BZ_AMOUNT": BZ_AMOUNT,
								//									"INVOICE_ID": INVOICE_ID,
								//									"VOUCHER_TYPE": VOUCHER_TYPE,
								//									"USE_BALANCE": USE_BALANCE,
								//								},
								//								createNew: true,
								//							});
								var attrValue = {
									"CERTIFICATE_ID": CERTIFICATE_ID,
									"re_submit": re_submit,
									"BZ_AMOUNT": BZ_AMOUNT,
									"INVOICE_ID": INVOICE_ID,
									"VOUCHER_TYPE": VOUCHER_TYPE,
									"USE_BALANCE": USE_BALANCE,
									backId: "account_reimbur_me"
								}
								booking.closeAndOpenNewWindowHaveAttr(
									'findpeople.html',
									'findpeople',
									attrValue
								)
							} else {

								document.getElementById("next").removeAttribute('disabled');
								var ss = plus.webview.getWebviewById("findpeople");
								if(ss) {
									plus.webview.close(ss);
								}
								//							mui.openWindow({
								//								id: 'findpeople',
								//								url: 'findpeople.html',
								//								extras: {
								//									"BZ_AMOUNT": BZ_AMOUNT,
								//									"INVOICE_ID": INVOICE_ID,
								//									"VOUCHER_TYPE": VOUCHER_TYPE,
								//									"USE_BALANCE": USE_BALANCE,
								//								},
								//								createNew: true,
								//							});
								var attrValue = {
									"BZ_AMOUNT": BZ_AMOUNT,
									"INVOICE_ID": INVOICE_ID,
									"VOUCHER_TYPE": VOUCHER_TYPE,
									"USE_BALANCE": USE_BALANCE,
									backId: "account_reimbur_me"
								}
								booking.closeAndOpenNewWindowHaveAttr(
									'findpeople.html',
									'findpeople',
									attrValue
								)
							}
						}

					});
				}
			})

			//			function circle() {
			//				var point = $(".change_bgimg");
			//				var num = parseInt(point.find("p").html());
			//
			//				for(var i = 0; i < list.length; i++) {
			//					var des = list[i].des;
			//					des = parseInt(des.substring(0, 1));
			//
			//					if(num == des) {
			//						if(list[i].num > 0) {
			//							$("#no_use").html("可使用消费券" + list[i].num + "张");
			//							$("#kaiguan").show();
			//							have_num = list[i].num;
			//							break;
			//						}
			//					} else {
			//						$("#no_use").html("你没有可使用的消费券");
			//						$("#kaiguan").hide();
			//					}
			//				}
			//
			//			}
		</script>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<!--<a href="how_account.html" class="mui-btn-blue mui-btn-link mui-pull-right" id="detail">如何报账?</a>-->
			<h1 class="mui-title">申请补贴</h1>
		</header>
		<div class="invoice_content">
			<span class="please">发票信息</span>
			<div id="fapiao" class="img_invoice">
				<img id="fpImage" class="fpimage" src="../../img/bus_info/icon-img-fp.png" />
			</div>
			<li class="mui-table-view-cell" style="display: none;">
				<span class="use_money">可使用未报账金额</span>
				<span class="money">&#165;<span id="amonut">0.00</span></span>
				<div class="mui-switch mui-switch-mini " id="balan">
					<div class="mui-switch-handle"></div>
				</div>
			</li>
			<li class="mui-table-view-cell">
				<span class="use_money ">今日剩余补贴金额</span>
				<span class="money">&#165;<span id="amonut_sy">0.00</span></span>
			</li>
		</div>
		<div class="invoice_value">
			<label>可补贴发票金额(元)</label>
			<input type="number" id="fp_money" disabled="disabled" />
		</div>
		<div class="invoice_value">
			<label>本次补贴金额(元)</label>
			<input type="number" id="bz_money" placeholder="请输入本次补贴金额" />
		</div>
		<div class="tips">
			<p class="tip">补贴金额只能是100的整数倍</p>
		</div>
		<!--<div class="reim_level">
			<span>报账档次</span>
			<span class="check_dis">请选择您的报账档次</span>
		</div>-->
		<!--<div class="img_quan">
			<ul class="circle" id="dangci">
				<li>
					<div class="dis_img fl">
						<p class="art_text default">8</p>
					</div>
				</li>
			
				<li>
					<div class="dis_img fl">
						<p class="art_text default">6</p>
					</div>
				</li>
				<li>
					<div class="dis_img fl">
						<p class="art_text default">5</p>
					</div>
				</li>
			</ul>
		</div>-->
		<div class="use_orno">
			<li class="mui-table-view-cell">
				<span class="use_money" id="no_use"></span>

				<div class="mui-switch mui-switch-mini" id="kaiguan" style="display: none;">
					<div class="mui-switch-handle" id="handle"></div>
				</div>
			</li>
		</div>
		<div style="color: red;margin-left: 10px;"><span><i class="mui-icon mui-icon-info"></i>温馨提示：<span style="color: #999;">审核时间为工作日9:00 －18:00</span></span>
		</div>
		<button id="next" type="button" class="mui-btn mui-btn-success mui-btn-block com_btn" id="next">下一步</button>
	</body>

</html>