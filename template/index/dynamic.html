<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>实时动态</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" href="../../css/mui.min.css">
		<style type="text/css">
			.mui-table-view-cell>a:not(.mui-btn) {
				margin: 0 !important;
			}
			
			.mui-table-view-chevron .mui-table-view-cell {
				padding-right: 10px;
			}
			
			.mui-scroll-wrapper {
				position: absolute !important;
			}
			
			#pullrefresh {
				width: 100%;
			}
		</style>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">实时动态</h1>
		</header>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper mui-conten">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view mui-table-view-chevron" id="scoll_content">
					<!--<li class="mui-table-view-cell">
						<div class="info_pos">
							<img src="../../img/home/info_msg.png" class="info_icon fl" />
							<p class="msg_time"><span class="in_day">8月13日</span><span class="in_phone">用户：138****1111</span><span class="out_money">补贴金额200.00元</span></p>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="info_pos">
							<img src="../../img/home/info_msg.png" class="info_icon fl" />
							<p class="msg_time"><span class="in_day">8月13日</span><span class="in_phone">用户：138****1111</span><span class="out_money">补贴金额200.00元</span></p>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="info_pos">
							<img src="../../img/home/info_msg.png" class="info_icon fl" />
							<p class="msg_time"><span class="in_day">8月13日</span><span class="in_phone">用户：138****1111</span><span class="out_money">补贴金额200.00元</span></p>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="info_pos">
							<img src="../../img/home/info_msg.png" class="info_icon fl" />
							<p class="msg_time"><span class="in_day">8月13日</span><span class="in_phone">用户：138****1111</span><span class="out_money">补贴金额200.00元</span></p>
						</div>
					</li>
					<li class="mui-table-view-cell">
						<div class="info_pos">
							<img src="../../img/home/info_msg.png" class="info_icon fl" />
							<p class="msg_time"><span class="in_day">8月13日</span><span class="in_phone">用户：138****1111</span><span class="out_money">补贴金额200.00元</span></p>
						</div>
					</li>-->
				</ul>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript">
			mui.init({
				swipeBack: true,
				pullRefresh: {
					container: '#pullrefresh',
					up: {
						contentrefresh: '正在加载...',
						//						auto: true,
						callback: dynamic
					}
				}
			})
			var CERTIFICATE_ID = null;
			var auid = localStorage.getItem("auid");
			var count = 0;
			var size = 10;
			var isLogin = null;
			mui.plusReady(function() {
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {

					if(result.RESULTCODE == 0) {

						if(result.RESULTLIST.is_login == 1) {
							isLogin = 1;
							return;
						} else {
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						isLogin = 1;
						return;

					}
				});
				if(isLogin === 1) {

					mui.app_request('POST', {
						"OPERATE_TYPE": "10098",
						"BEGIN": "0",
						"SIZE": "15"
					}, function(data) {
						if(data.RESULTCODE == "0") {
							//mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > data.RESULTLIST.totalsize));
							var infolist = data.RESULTLIST.result;
							var page = 0;
							list_num(infolist, page, size)
							//$("#scoll_msg").css({"height":infolist.length*50 - 1 +"px","maxheight":"149px"})
						}
					}, function(result) {
						if(result.RESULTCODE == "-1") {
							mui.toast(result.DESCRIPTION)
						}
					});
				}
			})

			function dynamic() {
				setTimeout(function() {
					var page = $("#scoll_content").attr("page");
					mui.app_request('POST', {
						"OPERATE_TYPE": "10098",
						"BEGIN": page,
						"SIZE": size
					}, function(data) {
						if(data.RESULTCODE == "0") {
							mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > data.RESULTLIST.totalsize));
							var infolist = data.RESULTLIST.result;
							list_num(infolist, page, size);
						}
					}, function(result) {
						if(result.RESULTCODE == "-1") {
							mui.toast(result.DESCRIPTION)
						}
					});
				}, 1000);
			}

			function dataUtil(time_data) {
				var date = new Date(time_data.replace(/-/g, "/"));
				var month = date.getMonth() + 1;
				var day = date.getDate();
				//				var hour = date.getHours();
				//				var minutes = date.getMinutes();
				//				if(hour < 10) {
				//					hour = "0" + hour;
				//				}
				//				if(minutes < 10) {
				//					minutes = "0" + minutes;
				//				}
				return month + "月" + day + "日" // "  " + hour + ":" + minutes;
			}

			function list_num(infolist, page, size) {
				var info_list = '';
				if(infolist.length != 0) {

					for(var i = 0; i < infolist.length; i++) {
						info_list += '<li class="mui-table-view-cell">';
						info_list += '<div class="info_pos">';
						info_list += '<img src="../../img/home/info_msg.png" class="info_icon fl" />';
						info_list += '<p class="msg_time"><span class="in_day">' + dataUtil(infolist[i].create_time) + '</span><span class="in_phone">用户：' + replacePhone(infolist[i].username) + '</span><span class="out_money">' + infolist[i].des + infolist[i].amount + '元</span></p>';
						info_list += '</div></li>';
					}
					$("#scoll_content").attr("page", parseInt(page) + size)
					$("#scoll_content").append(info_list);
				} else if(infolist.length == 0 && page == 0) {
					_html = '<li class="mui-table-view-cell" style="text-align:center;padding-right:0;line-height:40px;">暂无数据</li>'
					$("#scoll_content").html(_html);
				}
			}
		</script>
	</body>

</html>