<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>绑定银行卡</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<script type="text/javascript" src="../../js/jquery-3.1.0.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
	</head>
	<style>
		#id_card {}
		
		.none {
			display: none;
		}
		
		.bank_row {
			margin-top: 10px;
			width: 68%;
		}
		
		.label {
			width: 30%;
		}
	</style>
	<script type="text/javascript">
		mui.init({
			swipeBack: true
		});
		mui.plusReady(function() {
			var auid = null;
			var tips = '绑定成功！'
			auid = localStorage.getItem("auid");
			var isLogin = null;
			mui.app_request("Post", {
				"OPERATE_TYPE": "10081",
				"AUTH_ID": localStorage.getItem("auid"),
			}, function(result) {

				if(result.RESULTCODE == 0) {

					if(result.RESULTLIST.is_login == 1) {

						return;
					} else {
						isLogin = 0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					}
				}

			}, function(result) {
				if(result.RESULTCODE == -1) {
					isLogin = 0;
					mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
						localStorage.removeItem("auid");
						booking.closeAndOpenNewWindow("../login/login.html", "login");
					});
					return;
				} else {

					return;

				}
			});
			if(isLogin === 0) {
				return;
			}
			mui.app_request('POST', {
				"OPERATE_TYPE": "10023",
				"AUTH_ID": auid
			}, function(data) {
				if(data.RESULTCODE == "0") {
					$("#pay_getnum").val(data.RESULTLIST.ida_info.real_name)
				}
				return;
			}, function(result) {
				mui.toast("系统异常，请重试");
			});
			console.log(auid)
			//查询商铺是否绑定银行卡
			mui.app_request("Post", {
				"OPERATE_TYPE": "10056",
				"AUTH_ID": auid, //localStorage.getItem("auid")
			}, function(result) {
				if(result.is_bind == 1) {
					console.log(JSON.stringify(result));
					//$("#pay_getnum").val(result.shop_bank_account_info.account_num);
					$("#pay_getnum").attr('readonly', 'readonly')
					var bank_card = formatBankNo(result.shop_bank_account_info.account_num);
					$("#id_card").val(bank_card);
					$("#id_card").attr('readonly', 'readonly')

					$("#open_bank").val(result.shop_bank_account_info.open_bank_name);

					$("#open_bank").attr('readonly', 'readonly')
					$(".mui-title").html("银行卡")
					$("#requerd").hide();
					$("#edit").show();
				}
				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {

					mui.toast(result.DESCRIPTION);
				} else {

					mui.toast("系统异常，请重试");
				}
			});

			document.getElementById("edit").addEventListener("tap", function() {
				var pay_name = document.getElementById("pay_getnum").value;
				var attrd = {
					"name": pay_name,
					"backId": "bindBank"
				}
				booking.closeAndOpenNewWindowHaveAttr("editBank.html", "editBank", attrd);
			})

			//绑定银行卡
			document.getElementById("requerd").addEventListener('tap', function() {
				this.setAttribute('disabled', 'disabled')
				bind_bankcard()
			})
		});

		//绑定银行卡
		function bind_bankcard() {
			var ACCOUNT_NAME = $("#pay_getnum").val();
			var ACCOUNT_NUM = $("#id_card").val();
			var OPEN_BANK_NAME = $("#open_bank").val();
			if(mui.isnull(ACCOUNT_NAME)) {
				mui.toast("账户名不能为空");
				document.getElementById("requerd").removeAttribute('disabled');
				return;
			}
			if(mui.isnull(ACCOUNT_NUM)) {
				mui.toast("账号不能为空");
				document.getElementById("requerd").removeAttribute('disabled');
				return;
			}
			if(mui.isnull(OPEN_BANK_NAME)) {
				mui.toast("开户行不能为空");
				document.getElementById("requerd").removeAttribute('disabled');
				return;
			}
			mui.app_request("Post", {
				"OPERATE_TYPE": "10043",
				"AUTH_ID": auid, //localStorage.getItem("auid")
				"ACCOUNT_NAME": ACCOUNT_NAME,
				"ACCOUNT_NUM": ACCOUNT_NUM,
				"OPEN_BANK_NAME": OPEN_BANK_NAME,
			}, function(result) {
				mui.toast(tips);
				document.getElementById("requerd").removeAttribute('disabled'); //恢复按钮为非禁用
				booking.closeAndOpenNewWindow('bus_accountment.html', 'bus_accountment');

				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					document.getElementById("requerd").removeAttribute('disabled'); //恢复按钮为非禁用
					mui.toast(result.DESCRIPTION);
				} else {
					document.getElementById("requerd").removeAttribute('disabled'); //恢复按钮为非禁用
					mui.toast("系统异常，请重试");
				}
			})
		}

		function formatBankNo(BankNo) {
			if(mui.isnull(BankNo)) return;

			var account = BankNo.substring(0, 22); /*账号的总数, 包括空格在内 */
			if(account.match(".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}") == null) {
				/* 对照格式 */
				if(account.match(".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}|" + ".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}|" +
						".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}|" + ".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}") == null) {
					var accountNumeric = accountChar = "",
						i;
					for(i = 0; i < account.length; i++) {
						accountChar = account.substr(i, 1);
						if(!isNaN(accountChar) && (accountChar != " ")) accountNumeric = accountNumeric + accountChar;
					}
					account = "";
					for(i = 0; i < accountNumeric.length; i++) { /* 可将以下空格改为-,效果也不错 */
						if(i == 4) account = account + " "; /* 账号第四位数后加空格 */
						if(i == 8) account = account + " "; /* 账号第八位数后加空格 */
						if(i == 12) account = account + " "; /* 账号第十二位后数后加空格 */
						if(i == 16) account = account + " ";
						if(i == 20) account = account + " ";
						account = account + accountNumeric.substr(i, 1)
					}
				}

			} else {
				account = " " + account.substring(1, 5) + " " + account.substring(6, 10) + " " + account.substring(14, 18) + "-" + account.substring(18, 25);
			}

			return account;
		}
	</script>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">绑定银行卡</h1>
			<a class=" mui-btn-link mui-pull-right detail_txt" style="display: none;" href="javascript:void(0);" id="edit">修改银行卡</a>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label class="label">收款账户名</label>
					<input type="text" id="pay_getnum" class="bank_row" placeholder="请输入您的收款账户名">
				</div>
				<div class="mui-input-row">
					<label class="label">收款账号</label>
					<input type="text" maxlength="25" id="id_card" class="bank_row" placeholder="请输入收款账号">
				</div>
				<div class="mui-input-row">
					<label class="label">开户支行</label>
					<input type="text" id="open_bank" class="bank_row" placeholder="请输入收款卡开户行支行">
				</div>
			</form>
		</div>
		<button id="requerd" type="button" status="true" class="mui-btn mui-btn-success mui-btn-block com_btn">提交</button>
		<!--<button id="updata" type="button" status="true" class="mui-btn mui-btn-success mui-btn-block none">我要更换账号</button>-->
	</body>

</html>