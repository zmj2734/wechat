<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的提现</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/in_pwd.css" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<script src="../../js/jquery-3.1.0.min.js" type="text/javascript"></script>
		<script src="../../js/mui.min.js" type="text/javascript"></script>
		<script src="../../js/common.js" type="text/javascript"></script>
		<script src="../../js/passwordBox.min.js"></script>
		<style type="text/css">
			#fund {
				width: 80%;
				font-size: 12px;
			}
			
			.with_info .name {
				font-size: 16px;
			}
			
			.with_info .phone {
				font-size: 18px;
				line-height: 52px;
				margin-top: 0px !important;
			}
			
			.mui-icon-info {
				font-size: 16px !important;
			}
			
			.wide_info .amont_money {
				font-weight: bold;
			}
			
			.wide_info .amont_roll,
			.amont_money .wide_price {
				font-size: 16px !important;
				font-weight: 500;
			}
			
			#true_fund {
				margin-left: 14px;
			}
			
			#tip {
				width: 100%;
				margin-top: 10px;
				display: inline-block;
				text-indent: 10px;
				font-size: 14px;
				color: #999;
			}
		</style>
		<script type="text/javascript">
			mui.init({
				swipeBack: true
			});
			var auid = localStorage.getItem("auid");
			var real = null;
			var type;
			var userType = null;
			var case_type = null;
			var pwd_word = null;
			mui.plusReady(function() {
				var isLogin = null;
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {

					if(result.RESULTCODE == 0) {

						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							isLogin = 0;
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						isLogin = 0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {

						return;

					}
				});
				if(isLogin === 0) {
					return;
				}
				if(!PwdBox.inited) {
					PwdBox.init('', '../../img/pwd_keyboard.png', '请输入支付密码', '安全支付环境，请放心使用！');
					$(".notice").html("<p>安全支付环境，请放心使用！</p><a id='forget' class='forget'>忘记密码?</a>")
				}
				document.getElementById("forget").addEventListener('tap', function() {
					booking.closeAndOpenNewWindow("find_pwd.html", "find_pwd")
				})
				type = plus.webview.currentWebview().type;

				if(type == "10088") {
					$("#tip").html("提现金额需≥500，且为100的整数倍")
				} else if(type == "10089") {
					$("#tip").hide()
				} else {

					$("#tip").html("提现金额需≥200，且为100的整数倍")
				}

				console.log("type:" + type)
				if(type == "10088" || type == "10089") {
					case_type = plus.webview.currentWebview().case_type;
				}

				mui.app_request('POST', {
					"OPERATE_TYPE": "10023",
					"AUTH_ID": auid //localStorage.getItem("auid")
				}, function(data) {
					if(data.RESULTCODE == "0") {
						userType = data.RESULTLIST.user_type;
						var cash_info = data.RESULTLIST.cash_info;
						real = data.RESULTLIST.ida_auth;
						pwd_word = data.RESULTLIST.my_base_info.pay_pwd;
						if(cash_info.is_binding_alipay == "0") {
							$("#no_bind").show();
						} else {
							$("#aliPayNO").html(cash_info.account_num);
							$("#yes_bind").show();
						}
					}
					return;
				}, function(result) {
					return;
				});
				document.getElementById("toappend").addEventListener("tap", function() {
					if(mui.isnull(pwd_word)) {
						mui.alert('您尚未设置支付密码，请前往“首页→我的→账号管理”设置支付密码。', '系统提示', function() {
							return;
						});
						return;
					}
					setDisabled("toappend"); //禁用按钮
					append_fund();
				});
				document.getElementById("detail").addEventListener('tap', function() {
					booking.closeAndOpenNewWindow("withdrawls_exp.html", "withdrawls_exp")
				});

				document.getElementById("bind_alipay").addEventListener('tap', function() {
					if(real == 0) {
						mui.toast("实名审核中...")
					} else if(real == -2) {
						var btnArray = ['去实名', '取消'];
						mui.confirm('只有实名用户可以绑定支付宝', '', btnArray, function(e) {
							if(e.index == 0) {
								booking.closeAndOpenNewWindow(
									'realname.html',
									'realname'
								)
							} else {
								return;
							}
						});
					} else {
						booking.closeAndOpenNewWindow(
							'bindAlipay.html',
							'bindAlipay'
						)
					}
				});

				function append_fund() {
					document.getElementById("fund").blur();
					var fund = parseInt(document.getElementById("fund").value);
					var funds = document.getElementById("fund").value;
					if(mui.isnull(funds)) {
						mui.toast("提现金额不能为空");
						remDisabled("toappend"); //恢复按钮为非禁用
						return;
					}

					console.log("userType:" + userType)

					if(type == "10089") {
						if(fund <= 2) {
							mui.toast("提现金额不足以支付手续费!");
							remDisabled("toappend"); //恢复按钮为非禁用
							return;
						}

						$("#tip").hide();
					} else if(type == "10088") {
						$("#fund").attr("placeholder", "提现金额必须是100的倍数，且最低为500元")

						if(fund < 500 || fund % 100 != 0) {
							mui.toast("提现金额需≥500，且为100的整数倍。");
							remDisabled("toappend"); //恢复按钮为非禁用
							return;
						}

					} else {
						$("#fund").attr("placeholder", "提现金额必须是100的倍数，且最低为200元")

						if(fund < 200 || fund % 100 != 0) {
							mui.toast("提现金额需≥200，且为100的整数倍。");
							remDisabled("toappend"); //恢复按钮为非禁用
							return;
						}
					}

					var yue = {
						"OPERATE_TYPE": type,
						"AUTH_ID": auid, //localStorage.getItem("auid")
						"AMOUNT": fund,
					}
					if(type == "10088" || type == "10089") {
						yue = {
							"OPERATE_TYPE": type,
							"AUTH_ID": auid, //localStorage.getItem("auid")
							"AMOUNT": fund,
							"CASH_TYPE": case_type
						}
					}
					console.log(JSON.stringify(yue));

					PwdBox.show(function(res) {
						//console.log(JSON.stringify(res)) 
						if(res.status) {
							//重置输入
							var pay_pwd = res.password;
							console.log(pay_pwd)
							mui.app_request('POST', {
								"OPERATE_TYPE": "10082",
								"AUTH_ID": auid, //localStorage.getItem("auid"),
								"PAY_PWD": pay_pwd,
							}, function(data) {
								console.log("000:" + JSON.stringify(data))
								if(data.RESULTCODE == "0") {
									if(data.RESULTLIST.is_ok == 1) {
										mui.app_request("Post", yue, function(data) {

											if(data.RESULTCODE == "0") {
												//关闭并重置密码输入
												//$("#pay_password").hide();
												setTimeout(function() {
													PwdBox.reset();
													mui.toast("申请成功，系统会尽快处理！");
													remDisabled("toappend"); //恢复按钮为非禁用    
													booking.closeAndOpenNewWindow(
														'mine.html',
														'mine'
													)
													return;
												}, 500)
												return;
											}
											return;
										}, function(result) {

											if(result.RESULTCODE == "-1") {
												PwdBox.reset();
												remDisabled("toappend");
												mui.toast(result.DESCRIPTION);
												return;
											} else {
												PwdBox.reset();
												remDisabled("toappend");
												mui.toast("系统异常，请重试！");
												return;
											}
											//remDisabled("btn_submit");
										});

									} else {
										mui.toast("密码错误！");
										return;
									}
								}
							}, function(result) {
								console.log(JSON.stringify(result))
								mui.toast(result.DESCRIPTION);
							});
						} else {
							PwdBox.reset();
							remDisabled("toappend");
							//alert(JSON.stringify(arguments));
						}
					}, remDisabled("toappend"))
				}
			})

			function drawMoney() {
				var fund = parseInt(document.getElementById("fund").value);

				if(mui.isnull(fund)) {
					document.getElementById("fund").value = "";
					mui.toast("不能输入非法字符");
					return;
				}

				if(fund <= 1000) {
					document.getElementById("true_fund").innerHTML = fund - 2;
				} else {
					var more = fund - 1000;
					if(isNaN(more)) {
						document.getElementById("true_fund").innerHTML = "";
					} else {
						var money = (998 + more - (more * 0.0015)).toFixed(2);
						if(type == "10089") {
							if(fund - money > 27) {
								document.getElementById("true_fund").innerHTML = fund - 27;
								return;
							}
						}
						document.getElementById("true_fund").innerHTML = (998 + more - (more * 0.0015)).toFixed(2);
					}
				}

			};
		</script>
	</head>

	<body>

		<div id="yes_bind" style="display:none ;" class="y_bind">

			<header id="header" class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
				<h1 class="mui-title">我要提现</h1>
				<button class="mui-btn mui-btn-blue mui-icon mui-icon-help mui-btn-link mui-pull-right" id="detail" style="padding-top: 0;"></button>
			</header>
			<div class="with_title fl">
				<img src="../../img/profit/pay.png" class="pay_img fl" />
				<div class="with_info fl">
					<!--<p class="name">支付宝</p>-->
					<p class="phone" id="aliPayNO"></p>
				</div>
			</div>
			<div class="wide_info fl">
				<p class="amont_roll">提现金额</p>
				<p class="amont_money">&yen;<input class="wide_price" id="fund" type="number" placeholder="请输入提现金额" oninput="drawMoney()" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}" onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'0')}else{this.value=this.value.replace(/\D/g,'')}" />
				</p>
			</div>
			<p id="tip">提现金额需≥100，且为100的整数倍</p>
			<div class="wide_info fl">
				<p class="amont_roll">实际到账金额</p>
				<p class="amont_money">&yen;<label class="wide_price" id="true_fund"></label>
				</p>
			</div>
			<!--<div class="captial_time fl">
				<img src="../../img/profit/time.png" class="pagage fl" />
				<p class="rece_time fl">到账时间</p>
				<p class="rece_tips fr">72小时内到账</p>
			</div>-->
			<!--<div class="mui-bar mui-bar-tab">-->
			<div style="color: red;margin-left: 10px;"><span><i class="mui-icon mui-icon-info"></i>温馨提示：</span></div>
			<div style="color: #999;margin-left: 10px;width: 90%;margin: 0 auto;"><span>1、手续费：单笔金额≤1000元，收取2元/笔；金额＞1000元，超出1000元的部分额外收取0.15%费用。</div>
			<div style="color: #999;margin-left: 10px;width: 90%;margin: 0 auto;">2、预计2个工作日内到账。</div>
			<button id="toappend" type="button" class="mui-btn mui-btn-success mui-btn-block com_btn">确认</button>
			<!--<button id="toappend" type="button" class="mui-btn mui-btn-success mui-btn-block cmt_btn">确认转出</button>-->
			<!--</div>-->
		</div>
		<div id="no_bind" style="display: none;">
			<header id="header" class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
				<h1 class="mui-title">我要提现</h1>
			</header>
			<div class="tobound" id="bind_alipay">
				<img src="../../img/profit/pay.png" class="bind_img fl" />
				<p class="to_tips fl">请先绑定您的支付宝</p>
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
		</div>

	</body>

</html>