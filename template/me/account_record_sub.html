<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的报账</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<style type="text/css">
			.que_module {
				margin-top: 0 !important;
				margin-bottom: 20px !important;
			}
			
			.mui-pull-bottom-tips {
				text-align: center;
			}
			
			.mui-table-view {
				background: none;
				/*margin-top: 75px;*/
			}
			
			.mui-scroll {
				width: 100% !important;
			}
			
			.mui-segmented-control .mui-control-item.mui-active {
				color: #fff !important;
				background-color: #007aff !important;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				display: table-cell !important;
			}
			
			.acount_detail .bz_people {
				width: 100% !important;
			}
			
			.acount_detail p {
				text-align: left !important;
				margin-left: 15px !important;
			}
			
			.mui-scroll-wrapper {
				position: absolute !important;
				/*padding-top: 125px;*/
			}
			
			#segmentedControl {
				height: 40px;
				line-height: 40px;
			}
			
			.mui-segmented-control .mui-control-items {
				line-height: 38px;
				display: table-cell;
				overflow: hidden;
				width: 1%;
				-webkit-transition: background-color .1s linear;
				transition: background-color .1s linear;
				text-align: center;
				white-space: nowrap;
				text-overflow: ellipsis;
				border-color: #007aff;
				border-left: 1px solid #E6E6E6;
				border-bottom: 1px solid #E6E6E6;
				background: #efeff4;
			}
			
			.mui-segmented-control .mui-control-items.mui-active {
				background: #007aff !important;
				color: #fff;
			}
			
			#sliderSegmentedControl {
				width: 100%;
				display: inline-block;
				position: fixed;
				z-index: 9999;
				top: 45px;
				background: white;
			}
			
			.a_click {
				width: 50%;
				float: left;
				text-align: center;
				margin-top: 0;
			}
			
			.vter_line {
				top: 35px;
			}
		</style>
		<script>
			window.onload = function() {
				mui('.mui-scroll-wrapper').scroll({
					deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
				});
			}
			mui.init({
				swipeBack:true
			});
			//(function($) {
			var auid = null;
			mui.plusReady(function() {
				
				
				var u = navigator.userAgent;
				var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
				var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端

				if(isAndroid == true) {
					var height = document.body.clientHeight;
					$("#body_margin").css('margin-top', -80 + "px");
					$("#pullrefresh").css('height', height - 174 + "px");
					$("#pullrefresh").css('margin-top', 220 + "px");
				}
				if(isiOS == true) {
					var height = document.body.clientHeight;
					$("#pullrefresh").css('overflow', ' hidden');
					$("#pullrefresh").css('height', height - 144 + "px");
					$("#pullrefresh").css('margin-top', 190 + "px");
					$("#body_margin").css('margin-top', -50 + "px");
				}
				mui('.mui-slider').slider().setStopped(true);
				auid = localStorage.getItem("auid");
				var old_back = mui.back;
				mui.back = function() {
					var wobj = plus.webview.getWebviewById("index"); //注意 HBuilder 是   1.html 的 ID  你如果1.html 有ID   要替换掉HBuilder，  
					old_back()
				}
				var item = $("#segmentedControl .a_click.mui-active").attr("con");
				var bz_state = $("#segmentedControl .a_click.mui-active").attr("value");
				var ul = $("#segmentedControl .a_click.mui-active");
				var page = $("#segmentedControl .a_click.mui-active").attr("page");
				createFragment(ul, page, bz_state, item, 10, true);

				$("#segmentedControl .a_click").click(function() {
					$(this).addClass("mui-active").siblings().removeClass("mui-active");
					var index = $(this).index();
					$(".mui-slider-group .length").eq(index).show().siblings().hide();
					var item = $(this).attr("con");
					var bz_state = $(this).attr("value");
					var ul = $(this);
					var page = 0;
					createFragment(ul, page, bz_state, item, 10, true);
				});
				//获取报账金额
				mui.app_request('POST', {
					"OPERATE_TYPE": "10040",
					"AUTH_ID": auid,
				}, function(data) {
					if(data.RESULTCODE == "0") {
						var total_amount= data.RESULTLIST.total_amount;
						var turnover_num = 0;
						var result = (total_amount.toString()).indexOf(".");
					    if(result != -1) {
					        //alert("含有小数点");
					        var leng = total_amount.toString().split(".")[1].length;
					        if(leng==1){
					        	turnover_num = total_amount+'0';
					        }else if(leng>2){
					        	turnover_num = total_amount.toString().split(".")[0] + '.' + total_amount.toString().split(".")[1].substr(0,2)
					        }else{
					        	 turnover_num = total_amount
					        }
					    } else {
					      turnover_num = total_amount + '.00'
					    }
						$("#banlance_sub").html(turnover_num)

					}
					return;
				}, function(result) {

					return;
				});
				console.log(auid)
				mui.app_request('POST', {
					"OPERATE_TYPE": "10041",
					"AUTH_ID": auid,
				}, function(data) {
					if(data.RESULTCODE == "0") {
						var total_proxy_amount=data.RESULTLIST.total_proxy_amount;
						console.log("total_proxy_amount:"+total_proxy_amount)
						var turnover_num = 0;
						var result = (total_proxy_amount.toString()).indexOf(".");
					    if(result != -1) {
					        //alert("含有小数点");
					        var leng = total_proxy_amount.toString().split(".")[1].length;
					        if(leng==1){
					        	turnover_num = total_proxy_amount+'0';
					        }else if(leng>2){
					        	turnover_num = total_proxy_amount.toString().split(".")[0] + '.' + total_proxy_amount.toString().split(".")[1].substr(0,2)
					        }else{
					        	turnover_num=total_proxy_amount;
					        }
					    } else {
					      turnover_num = total_proxy_amount + '.00'
					    }
						console.log("turnover_num:"+turnover_num)
						$("#banlance_other").html(turnover_num)

					}
					return;
				}, function(result) {

					return;
				});

				//循环初始化所有下拉刷新，上拉加载。
				$.each($('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
					mui(pullRefreshEl).pullToRefresh({
						up: {
							container: '#pullrefresh',
							contentnomore: '没有更多数据了',
							callback: function() {
								var self = this;
								setTimeout(function() {
									var ul = self.element.querySelector('.mui-table-view');
									var item = ul.getAttribute("con");
									var bz_state = $("#segmentedControl").find(".a_click.mui-active").attr("value");
									var page = $("#segmentedControl").find(".a_click.mui-active").attr("page");
									var ul = $("#segmentedControl").find(".a_click.mui-active");
									createFragment(ul, page, bz_state, item, 10, false)
									//ul.appendChild(createFragment(item,5));
									self.endPullUpToRefresh();
								}, 1000);
							}
						}
					});
				});

				function createFragment(ul, page, bz_state, item, count, is) {
					var data;
					if(bz_state == "0") {
						data = {
							"OPERATE_TYPE": "10040",
							"AUTH_ID": auid, //localStorage.getItem("auid")
							"BEGIN": page,
							"SIZE": count,
						}
					} else {
						data = {
							"OPERATE_TYPE": "10041",
							"AUTH_ID": auid, //localStorage.getItem("auid")
							"BEGIN": page,
							"SIZE": count,
						}
					}
					mui.app_request("Post", data, function(result) {
						var data = result.RESULTLIST.result;
						var _html = '';
						if(bz_state == "0") {
							for(var i = 0; i < data.length; i++) {
								var sData = data[i];
								var amount = sData.amount;
								_html += '<div class="bus_content">';
								_html += '<div class="left_time">';
								_html += '<p><span class="sub_reim">消费补贴：</span><span class="sub_price">' + amount.toFixed(2) + '</span></p>';
								_html += '<span><span class="sub_time">' + sData.create_time + '</span></span>';
								_html += '</div>';
								_html += '<div class="fr">';
								_html += '<p><span class="other_name">服务商家</span></p>';
								_html += '<span class="other_info fr"><span class="other_peo"></span><span class="other_phone">' + sData.proxy_nickname + '</span></span>';
								_html += '</div>';
								_html += '</div>';
							}
						} else {
							for(var i = 0; i < data.length; i++) {
								var sData = data[i];
								var amount = sData.amount;
								_html += '<div class="bus_content">';
								_html += '<div class="left_time">';
								_html += '<p><span class="sub_reim">代服务：</span><span class="sub_price">' + amount.toFixed(2) + '</span></p>';
								_html += '<span><span class="sub_time">' + sData.create_time + '</span></span>';
								_html += '</div>';
								_html += '<div class="fr">';
								_html += '<p><span class="other_name"></span></p>';
								_html += '<span class="other_info fr"><span class="other_peo">申请人：</span><span class="other_phone">' + sData.bz_username + '</span></span>';
								_html += '</div>';
								_html += '</div>';
							}
						}

						if(ul == null) {

						} else {
							ul.attr("page", parseInt(page) + parseInt(count));
						}

						if(is == true) {
							$("." + item).html(_html)
						} else {
							$("." + item).append(_html)
						};
						return;
					}, function(result) {
						mui.toast(result.DESCRIPTION);
						return;
					})
				};

				//跳转我要报账页面
				//				document.getElementById("detail").addEventListener('tap', function() {
				//					mui.app_refresh("reimbur");
				//					mui.openWindow({
				//						id: 'reimbur',
				//						url: 'reimbur_me.html',
				//						extras: {
				//							type: 0,
				//							backId: "reimbur_me"
				//						}
				//					});
				//				});
				document.getElementById("fp-close").addEventListener('tap', function() {
					$("#fp-src").removeAttr("src");
					$("#fp-img").hide();
				});

			});

			function dateUtil(a) {
				return a.substring(0, 10);
			}
			//})(mui);
		</script>
	</head>

	<body style="border: 1px rgba(000,000,000,0) solid;" id="body_margin">
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">补贴记录</h1>
			<!--<button class="mui-btn mui-btn-blue mui-btn-link mui-pull-right" id="detail">我要报账</button>-->
		</header>

		<div class="fp-img" id="fp-img" style="display: none;">
			<div class="fp-imgNr">
				<a id="fp-close" href="javascript:void(0);"><img src="../../img/profit/close.png" /></a>
				<img id="fp-src" src="../../img/bus_info/bus.gif" />
			</div>
		</div>
		<div id="slider" class="mui-slider">
			<div id="sliderSegmentedControl">
				<div class="mui-scroll mui-segmented-control" id="segmentedControl">
					<div class="banlance mui-active a_click" page="0" value="0" con="item_1">
						<p class="submitted"><span>消费补贴(元)</span></p>
						<p class="count_reim"><span id="banlance_sub" class="red">0.00</span></p>
					</div>
					<div class="fl ac_top a_click" page="0" value="1" con="item_2">
						<p class="submitted"><span>代服务(元)</span></p>
						<p class="count_reim"><span id="banlance_other" class="red">0.00</span></p>
					</div>
					<hr class="vter_line" />
				</div>
			</div>
			<div class="mui-slider-group" id="pullrefresh">
				<div id="item1mobile" class="mui-slider-item mui-control-content length" value="0">
					<div id="scroll1" class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view item_1" con="item_1">
								
							</ul>
						</div>
					</div>
				</div>
				<div id="item2mobile" class="mui-slider-item mui-control-content length" value="1">
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view item_2" con="item_2">
							
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

</html>