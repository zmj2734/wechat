<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>商铺收益</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<script src="../../js/jquery-3.1.0.min.js" type="text/javascript"></script>
		<script src="../../js/mui.min.js" type="text/javascript"></script>
		<script src="../../js/common.js" type="text/javascript"></script>
		<style type="text/css">
			.c_pro {
				padding-top: 0;
				margin-top: -45px;
			}
			#body_margin{
				overflow: hidden;
				height: 100% !important;
			}
			.mui-scroll-wrapper{
				position: absolute !important;
			}
			.sub_type{
				font-weight: 500 !important;
				color: #666 !important;
			}
		</style>
		<script type="text/javascript">
			mui.init({
				swipeBack:true,
				pullRefresh: {
					container: "#pullrefresh", //待刷新区域标识
					up: {
						contentrefresh: "正在加载...", //可选，正在加载状态时，上拉加载控件上显示的标题内容
						callback: fundmore, //必选，刷新函数，根据具体业务来编写，比如通过ajax从服务器获取新数据；
					}
				}
			});
			var auid = localStorage.getItem("auid");
			var list_num = 0;
			var size = 10;
			mui.plusReady(function() {
				var isLogin = null;
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {
				
					if(result.RESULTCODE == 0) {
							
						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							isLogin =0;
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						isLogin =0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						
						return;

					}
				});
				if(isLogin === 0){
					return;
				}
				if(mui.os.android){
					var height = document.body.clientHeight;
					$("#pullrefresh").css('overflow', 'auto');
				}
				if(mui.os.ios){ 
					var height = document.body.clientHeight;
					$("#pullrefresh").css('overflow',' hidden');
				}
					mui.app_request('POST', {
						"OPERATE_TYPE": "10094",
						"AUTH_ID": auid,
						"BEGIN": list_num,
						"SIZE": size
					}, function(data) {
						console.log(JSON.stringify(data));
						if(data.RESULTCODE == "0") {
							var list = data.RESULTLIST.result;
							listData(list);
							list_num = list_num + size;
						}
						return;
					}, function(result) {
						if(result.RESULTCODE == "-1") {
							mui.toast(result.DESCRIPTION);
						} else {
							mui.toast("系统异常，请重试");
						}
						return;
					});
				
				document.getElementById("detail").addEventListener('tap', function() {
						booking.closeAndOpenNewWindow("voucher_history_exp.html","voucher_history_exp")
				});
			});
			//加载更多  
			function fundmore() {
				setTimeout(function() {
					
					mui.app_request('POST', {
						"OPERATE_TYPE": "10094",
						"AUTH_ID": auid,
						"BEGIN": list_num,
						"SIZE": size
					}, function(data) {
						if(data.RESULTCODE == "0") {
							var list = data.RESULTLIST.result;
							listData(list);
							list_num = list_num + size;
							if(list.length < size) {
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(true);
							} else {
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(false);
							}
						}
						return;
					}, function(result) {
						if(result.RESULTCODE == "-1") {
							mui.toast(result.DESCRIPTION);
						} else {
							mui.toast("系统异常，请重试");
						}
						return;
					});
				}, 1500)
			}

			function listData(list) {
				var _html = "";
				for(var i = 0; i < list.length; i++) {
					_html += '<div class="with_content">';
					_html += '<div class="left_time">';
					
					_html += '<p><span class="sub_type">' + list[i].des + '</span></p>';
					_html += '<span><span class="get_time">' + list[i].create_time + '</span></span>';
					_html += "</div>";
					_html += '<div class="fr">';
					if(list[i].num >0){
						_html += '<p><span class="profit red">' + list[i].num + '张</span></p>';
					}else{
						_html += '<p><span class="profit green">' + list[i].num + '张</span></p>';
					}
					
					_html += '</div></div>';
				}
				$("#messages").append(_html);
			}
		</script>
	</head>

	<body style="border: 1px rgba(000,000,000,0) solid;" id="body_margin">
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">我的消费券</h1>
			<button class="mui-btn mui-btn-blue mui-icon mui-icon-help mui-btn-link mui-pull-right" id="detail" style="padding-top: 0;"></button>
		</header>
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper" style=" padding-top: 47px;">
			<div class="mui-scroll">
			<div id="messages">
				<!--<div class="with_content">
					<div class="left_time">
						<p><span class="sub_type">222222222222</span></p>
						<span><span class="get_time">123123</span></span>
						</div>
						<div class="fr">
						<p><span class="profit">+10张</span></p>
					</div>
				</div>
				<div class="with_content">
					<div class="left_time">
						<p><span class="sub_type">123123</span></p>
						<span><span class="get_time">123123</span></span>
						</div>
						<div class="fr">
						<p><span class="profit">-15张</span></p>
					</div>
				</div>
				<div class="with_content">
					<div class="left_time">
						<p><span class="sub_type">123123</span></p>
						<span><span class="get_time">123123</span></span>
						</div>
						<div class="fr">
						<p><span class="profit">+20张</span></p>
					</div>
				</div>
				<div class="with_content">
					<div class="left_time">
						<p><span class="sub_type">123123</span></p>
						<span><span class="get_time">123123</span></span>
						</div>
						<div class="fr">
						<p><span class="profit">+1张</span></p>
					</div>
				</div>-->
			</div>
			</div>
		</div>
	</body>

</html>