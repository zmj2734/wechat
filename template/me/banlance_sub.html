<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的报账</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery-2.1.3.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script src="../../js/mui.pullToRefresh.js"></script>
		<script src="../../js/mui.pullToRefresh.material.js"></script>
		<style type="text/css">
			.que_module {
				margin-top: 0 !important;
				margin-bottom: 20px !important;
			}
			.banlance_info p{
				text-align: center;
				line-height: 76px;
			}
			.banlance_info .banPrice {
				font-size: 30px;
				font-weight: bold;
				margin-top: 0;
				color: #666;
				margin-left: 10px;
			}
			.mui-pull-bottom-tips {
				text-align: center;
			}
			
			.mui-table-view {
				background: none;
				/*margin-top: 75px;*/
			}
			
			.mui-scroll {
				width: 100% !important;
			}
			
			.mui-segmented-control .mui-control-item.mui-active {
				color: #fff !important;
				background-color: #007aff !important;
			}
			
			.mui-segmented-control.mui-scroll-wrapper .mui-control-item {
				display: table-cell !important;
			}
			
			.acount_detail .bz_people {
				width: 100% !important;
			}
			
			.acount_detail p {
				text-align: left !important;
				margin-left: 15px !important;
			}
			
			.mui-scroll-wrapper {
				position: absolute !important;
				padding-top: 80px;
			}
			
			#segmentedControl {
				height: 40px;
				line-height: 40px;
			}
			
			.mui-segmented-control .mui-control-items {
				line-height: 38px;
				display: table-cell;
				overflow: hidden;
				width: 1%;
				-webkit-transition: background-color .1s linear;
				transition: background-color .1s linear;
				text-align: center;
				white-space: nowrap;
				text-overflow: ellipsis;
				border-color: #007aff;
				border-left: 1px solid #E6E6E6;
				border-bottom: 1px solid #E6E6E6;
				background: #efeff4;
			}
			
			.mui-segmented-control .mui-control-items.mui-active {
				background: #007aff !important;
				color: #fff;
			}
			
			#sliderSegmentedControl {
				width: 100%;
				display: inline-block;
				position: fixed;
				z-index: 9999;
				top: 125px;
				background: white;
			}
			
			.a_click {
				width: 50%;
				float: left;
				text-align: center;
				margin-top: 0;
			}
			.a_click.mui-active{
				background: #f7f7f7;
			}
			.vter_line {
				height: 100%;
				top: -10px;
			}
			#pullrefresh{
				margin-top: 5px;
			}
			.withContent {
				width: 100%;
				height: 70px;
				background: white;
				float: left;
				border-bottom: 1px solid #E9E9E9;
			}
			
			.withContent .left_time {
				float: left;
			}
		</style>
		<script>
			window.onload = function() {
				mui('.mui-scroll-wrapper').scroll({
					deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
				});
			}
			mui.init({
				swipeBack:true
			});
			//(function($) {
			var win = null;
			var banlance = null;
			var contentWebview = null;
			var my_base_info = null;
			var voucher_info = null;
			var profit_info = null;
			var my_bz_info = null;
			var cash_info = null;

			var auid = localStorage.getItem("auid");;
			var ida_auth = null;
			var operate_type = null;
			var bind_pay;
			var list_num = 0;
			var my_base_info = null;
			var type = 0;
			var word = 0;
			var size = 10;
			mui.plusReady(function() {
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {
					console.log(JSON.stringify(result))
					if(result.RESULTCODE == 0) {

						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						return;

					}
				});
				document.querySelector('header').addEventListener('doubletap', function() {
					if(contentWebview == null) {
						contentWebview = plus.webview.currentWebview().children()[0];
					}
					contentWebview.evalJS("mui('#pullrefresh').pullRefresh().scrollTo(0,0,100)");
				});

				win = plus.webview.currentWebview();
				banlance = win.money;
				$("#banlance").html(banlance);

				mui.app_request('POST', {
					"OPERATE_TYPE": "10023",
					"AUTH_ID": auid
				}, function(data) {
					if(data.RESULTCODE == "0") {
						my_base_info = data.RESULTLIST.my_base_info;
						voucher_info = data.RESULTLIST.voucher_info;
						profit_info = data.RESULTLIST.profit_info;
						my_bz_info = data.RESULTLIST.my_bz_info;
						type = data.RESULTLIST.user_type;
						cash_info = data.RESULTLIST.cash_info;

						ida_auth = data.RESULTLIST.ida_auth;
						bind_pay = cash_info.is_binding_alipay;
						my_shop_info = data.RESULTLIST.my_shop_info;
						if(type == 1) {
							word = 10042;

						} else {
							word = 10052;

						}
						if(type == 1) {
							if(!mui.isnull(my_base_info.account_balance)) {
								$("#banlance").html((my_base_info.account_balance).toFixed(2));
							}
						} else {
							if(!mui.isnull(my_shop_info.account_balance)) {
								$("#banlance").html((my_shop_info.account_balance).toFixed(2));
							}
						}
					}
					return;
				}, function(result) {
					mui.toast("系统异常，请重试");
				});

				document.getElementById("detail").addEventListener("tap", function() {
					if(ida_auth == 1) {
						if(bind_pay == "0") {
							plus.nativeUI.confirm("为保障您的账户安全，请绑定本人的支付宝账号。", function(e) {
								if(e.index == 0) {
									return;
								} else {
									booking.closeAndOpenNewWindow("bindAlipay.html", "bindAlipay");
									return;
								}

							}, "提示", ["取消", "去绑定"]);
							return;
						} else {
							var fromType = null;
							if(type == "1"){
								fromType = "10024";
							}else{
								fromType = "10088";
							}
							var attrd ={
								"type":fromType,
								"case_type":2
							}
							
							booking.closeAndOpenNewWindowHaveAttr("withdrawals.html", "withdrawals",attrd);
						}

					} else if(ida_auth == 0) {
						mui.toast("实名审核中...")
						return;
					} else if(ida_auth == -2) {
						plus.nativeUI.confirm("为保障您账户安全，请先完成身份认证。", function(e) {
							if(e.index == 0) {
								return;
							} else {
								booking.closeAndOpenNewWindow("realname.html", "realname");
								return;
							}

						}, "提示", ["取消", "去认证"]);
					}
				})
				
				var u = navigator.userAgent;
				var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //android终端
				var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //ios终端

				if(isAndroid == true) {
					var height = document.body.clientHeight;
					$("#body_margin").css('margin-top', -80 + "px");
					$("#pullrefresh").css('height', height - 174 + "px");
					$("#pullrefresh").css('margin-top', 220 + "px");
				}
				if(isiOS == true) {
					var height = document.body.clientHeight;
					$("#pullrefresh").css('overflow', ' hidden');
					$("#pullrefresh").css('height', height - 144 + "px");
					$("#pullrefresh").css('margin-top', 190 + "px");
					$("#body_margin").css('margin-top', -50 + "px");
				}
				mui('.mui-slider').slider().setStopped(true);
				auid = localStorage.getItem("auid");
				var old_back = mui.back;
				mui.back = function() {
					var wobj = plus.webview.getWebviewById("index"); //注意 HBuilder 是   1.html 的 ID  你如果1.html 有ID   要替换掉HBuilder，  
					old_back()
				}
				var item = $("#segmentedControl .a_click.mui-active").attr("con");
				var bz_state = $("#segmentedControl .a_click.mui-active").attr("value");
				var ul = $("#segmentedControl .a_click.mui-active");
				var page = $("#segmentedControl .a_click.mui-active").attr("page");
				createFragment(ul, page, bz_state, item, 10, true);

				$("#segmentedControl .a_click").click(function() {
					$(this).addClass("mui-active").siblings().removeClass("mui-active");
					var index = $(this).index();
					$(".mui-slider-group .length").eq(index).show().siblings().hide();
					var item = $(this).attr("con");
					var bz_state = $(this).attr("value");
					var ul = $(this);
					var page = 0;
					createFragment(ul, page, bz_state, item, 10, true);
				});
				
				mui.app_request("Post", {
					"OPERATE_TYPE": word,
					"AUTH_ID": auid, //localStorage.getItem("auid")
					"BEGIN": page,
					"TYPE": -1,
					"SIZE": size
				}, function(result) {
					console.log(JSON.stringify(result))
					if(result.RESULTCODE == 0) {
						var money = result.RESULTLIST.countAmount;
						if(mui.isnull(money)){
							money = 0
						}
						$("#banlance_sub").html(parseInt(money).toFixed(2))
					}
					return;
				}, function(result) {
					mui.toast(result.DESCRIPTION);
						return;
				});
				mui.app_request("Post", {
					"OPERATE_TYPE": word,
					"AUTH_ID": auid, //localStorage.getItem("auid")
					"BEGIN": page,
					"TYPE": 1,
					"SIZE": size
				}, function(result) {
					console.log(JSON.stringify(result))
					if(result.RESULTCODE == 0) {
						var money = result.RESULTLIST.countAmount;
						if(mui.isnull(money)){
							money = 0
						}
						$("#banlance_other").html(parseInt(money).toFixed(2))
					}
					return;
				}, function(result) {
					mui.toast(result.DESCRIPTION);
						return;
				});

				//循环初始化所有下拉刷新，上拉加载。
				$.each($('.mui-slider-group .mui-scroll'), function(index, pullRefreshEl) {
					mui(pullRefreshEl).pullToRefresh({
						up: {
							container: '#pullrefresh',
							contentnomore: '没有更多数据了',
							callback: function() {
								var self = this;
								setTimeout(function() {
									var ul = self.element.querySelector('.mui-table-view');
									var item = ul.getAttribute("con");
									var bz_state = $("#segmentedControl").find(".a_click.mui-active").attr("value");
									var page = $("#segmentedControl").find(".a_click.mui-active").attr("page");
									console.log("page:"+page)
									var ul = $("#segmentedControl").find(".a_click.mui-active");
									createFragment(ul, page, bz_state, item, 10, false)
									//ul.appendChild(createFragment(item,5));
									self.endPullUpToRefresh();
								}, 1000);
							}
						}
					});
				});

				function createFragment(ul, page, bz_state, item, count, is) {
					var data;
//					if(bz_state == "0") {
//						data = {
//							"OPERATE_TYPE": word,
//							"AUTH_ID": auid, //localStorage.getItem("auid")
//							"BEGIN": page,
//							"SIZE": size
//						}
//					} else {
	
						data = {
							"OPERATE_TYPE": word,
							"AUTH_ID": auid, //localStorage.getItem("auid")
							"BEGIN": page,
							"TYPE": bz_state,
							"SIZE": size
						}
//					}
					console.log(JSON.stringify(data))
					mui.app_request("Post", data, function(result) {
						var data = result.RESULTLIST.result;
						var _html = '';
						for(var i = 0; i < data.length; i++) {
							_html += '<div>'
							_html += '<div class="withContent">';
							_html += '<div class="left_time">';
							_html += '<p><span class="sub_type" style="color:#666666;font-weight:400;">' + data[i].des + '</span></p>';
							_html += '<span><span class="get_time">' + data[i].create_time + '</span></span>';
							_html += '</div>';
							_html += '<div class="fr">';
							_html += '<p><span class="profit">' + (data[i].amount).toFixed(2) + '</span></p>';
							_html += '</div>';
							_html += '</div>'
						}
						if(ul == null) {

						} else {
							ul.attr("page", parseInt(page) + parseInt(count));
						}

						if(is == true) {
							$("." + item).html(_html)
						} else {
							$("." + item).append(_html)
						};
						return;
					}, function(result) {
						mui.toast(result.DESCRIPTION);
						return;
					})
				};


			});

			function dateUtil(a) {
				return a.substring(0, 10);
			}
			//})(mui);
		</script>
	</head>

	<body style="border: 1px rgba(000,000,000,0) solid;" id="body_margin">
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">余额</h1>
			<button class="mui-btn mui-btn-blue mui-btn-link mui-pull-right detail_txt" id="detail" style="font-size: 14px;">我要提现</button>
		</header>
		<div class="banlance_info" style="z-index: 4;position:fixed;top: 45px;left: 0;">
			<!--<p class="account" style="font-size: 16px;margin-top: 0px;margin-bottom:10px ;">账户余额</p>-->
			<p class="banPrice"><span>&yen;</span><span id="banlance">0.00</span></p>
		</div>
		<div id="slider" class="mui-slider">
			<div id="sliderSegmentedControl">
				<div class="mui-scroll mui-segmented-control" id="segmentedControl">
					<div class="banlance mui-active a_click" page="0" value="-1" con="item_1">
						<p class="submitted"><span>支出(元)</span></p>
						<p class="count_reim"><span id="banlance_sub" class="red">0.00</span></p>
					</div>
					<div class="fl ac_top a_click" page="0" value="1" con="item_2">
						<p class="submitted"><span>收入(元)</span></p>
						<p class="count_reim"><span id="banlance_other" class="red">0.00</span></p>
					</div>
					<hr class="vter_line" />
				</div>
			</div>
			<div class="mui-slider-group" id="pullrefresh">
				<div id="item1mobile" class="mui-slider-item mui-control-content length" value="0">
					<div id="scroll1" class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view item_1" con="item_1">
								<div>
							<div class="withContent">
							<div class="left_time">
							<p><span class="sub_type" style="color:#666666;font-weight:400;">23123</span></p>
							<span><span class="get_time">23123</span></span>
							</div>
							<div class="fr">
							<p><span class="profit">1</span></p>
							</div>
							</div>
							</ul>
						</div>
					</div>
				</div>
				<div id="item2mobile" class="mui-slider-item mui-control-content length" value="1">
					<div class="mui-scroll-wrapper">
						<div class="mui-scroll">
							<ul class="mui-table-view item_2" con="item_2">
							
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>

</html>