<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>账号管理</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" src="../../js/jquery-3.1.0.min.js"></script>
		<style type="text/css">
			#exit {
				padding: 12px 0 !important;
				font-size: 16px !important;
				background: #0499E6;
				color: #fff;
			}
			
			.cleft_name {
				font-size: 16px !important;
			}
			
			.tip {
				font-size: 14px;
			}
			
			.f00 {
				color: #30b776 !important;
			}
			
			.icon-sm {
				max-width: 100%;
				display: block;
				width: 60px;
			}
			
			#r_gotoname div.fr {
				height: auto;
				display: block;
				margin-top: 10px;
				margin-right: 10px;
			}
		</style>
		<script type="text/javascript">
			mui.init({
				swipeBack: true
			});
			var my_base_info = null;
			var cash_info = null;
			var nickName = "";
			var pwd_word = "";
			var head_image = "";
			var domain_url = booking.constants.domain;
			var auid = localStorage.getItem("auid");
			var card = 0;
			var type = null;
			var bind_card = null;
			var bind_pay = null;
			mui.plusReady(function() {
				var isLogin = null;
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {
				
					if(result.RESULTCODE == 0) {
							
						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							isLogin =0;
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						isLogin =0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						
						return;

					}
				});
				if(isLogin === 0){
					return;
				}
				//判断是否绑定银行卡
				mui.app_request("Post", {
					"OPERATE_TYPE": "10077",
					"AUTH_ID": auid, //localStorage.getItem("auid")
				}, function(result) {
					card = result.RESULTLIST.is_bind;
					if(result.RESULTLIST.is_bind == 1) {
						$("#yes_bind").show();
					}
					if(result.RESULTLIST.is_bind == 0) {
						$("#yes_bind").hide();
					}

					return;
				}, function(result) {
					if(result.RESULTCODE == "-1") {
						mui.toast(result.DESCRIPTION);
						return;
					} else {
						mui.toast("系统异常，请重试");
						return;
					}
				});

				mui.app_request('POST', {
					"OPERATE_TYPE": "10023",
					"AUTH_ID": auid
				}, function(data) {
					if(data.RESULTCODE == "0") {
						my_base_info = data.RESULTLIST.my_base_info;
						cash_info = data.RESULTLIST.cash_info;
						type = data.RESULTLIST.user_type;
						nickName = my_base_info.nickname;
						pwd_word = my_base_info.pay_pwd;
						head_image = my_base_info.header_img;
						if(!mui.isnull(my_base_info.header_img)) {
							$("#head_img").attr("src", booking.constants.ip + my_base_info.header_img);
						}
						if(!mui.isnull(my_base_info.nickname)) {
							$("#nickname").html(my_base_info.nickname);
						}
						bind_pay = cash_info.is_binding_alipay;
					}
					return;
				}, function(result) {
					return;
				});

				//查询商铺是否绑定银行卡
				mui.app_request("Post", {
					"OPERATE_TYPE": "10056",
					"AUTH_ID": auid, //localStorage.getItem("auid")
				}, function(result) {
					bind_card = result.is_bind;
					if(bind_card == 1) {
						$("#yesBank").show();
					} else {
						$("#noBank").show();
					}
					return;
				}, function(result) {
					if(result.RESULTCODE == "-1") {

						mui.toast(result.DESCRIPTION);
					} else {

						mui.toast("系统异常，请重试");
					}
				});

				document.getElementById("heads_img").addEventListener('tap', function() {

					var attrd = {
						"head_imgurl": head_image,
						"backId": "bus_accountment"
					};
					booking.closeAndOpenNewWindowHaveAttr("my_headimg.html", "my_headimg", attrd);
				});

				document.getElementById("exit").addEventListener('tap', function() {
					var btnArray = ['是', '否'];
					mui.confirm('确认退出登录吗?', '', btnArray, function(e) {
						if(e.index == 0) {
							localStorage.removeItem("auid");
							mui.app_filePath("info_system_sub");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						} else {
							return;
						}
					});

				});

				document.getElementById("bdpay").addEventListener('tap', function() {
					if(bind_pay == 0) {
						booking.closeAndOpenNewWindow("bindAlipay.html", "bindAlipay");
					} else if(bind_pay == 1) {
						booking.closeAndOpenNewWindow("bindpay.html", "bindpay");
					}
				});

				document.getElementById("r_name").addEventListener('tap', function() {
					var addrd = {
						"name": nickName,
						"backId": "bus_account_ment"
					}
					booking.closeAndOpenNewWindowHaveAttr("set_name.html", "setName", addrd);
				});

				document.getElementById("pay_pwd").addEventListener('tap', function() {
					if(mui.isnull(pwd_word)) {
						var attrd = {
							"backId": "bus_accountment"
						}
						booking.closeAndOpenNewWindowHaveAttr(
							'set_paypassword.html',
							'set_paypassword',
							attrd
						);
						
					} else {
						booking.closeAndOpenNewWindow("update_pwd.html", "update_pwd");
					}
				});

				document.getElementById("my_ment").addEventListener("tap", function() {
					if(type == "2") {
						booking.closeAndOpenNewWindow(
							'sign_info.html',
							'sign_info'
						);
					} else {
						booking.closeAndOpenNewWindow(
							'en_mer_data_ed.html',
							'en_mer_data_ed'
						);
					}

				})

				document.getElementById("back").addEventListener("tap", function() {
					booking.closeAndOpenNewWindow("mine.html", "mine")
				})

				document.getElementById("my_bankCard").addEventListener('tap', function() {
					console.log("bind_card:" + bind_card)
					if(bind_card == 0) {
						booking.closeAndOpenNewWindow("bindBankCard.html", "bindBankCard");
					} else if(bind_card == 1) {
						booking.closeAndOpenNewWindow("bind_bankcard.html", "bind_bankcard");
					}

				});
				document.getElementById("r_gotoname").addEventListener('tap', function() {
					mui.app_refresh("realnamed")
					mui.openWindow({
						id: 'realnamed',
						url: 'realnamed.html'
					});
				});
				document.getElementById("forgot_pwd").addEventListener('tap', function() {
					if(mui.isnull(pwd_word)) {
						mui.toast("请先设置支付密码");
						return;
					} else {
						var attrd = {
							"backId": "bus_accountment"
						}
						booking.closeAndOpenNewWindowHaveAttr(
							'find_pwd.html',
							'find_pwd',
							attrd
						);
					}

				});
			})
		</script>

	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class=" mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">账号管理</h1>
		</header>
		<div class="head_imgcont">
			<div class="img_head" id="heads_img">
				<p class="head_text cleft_name">我的头像</p>
				<div class="fr">
					<img src="" class="default_img" id="head_img" />
					<img src="../../img/default/right.png" class="right_acc" />
				</div>
			</div>
		</div>
		<div class="common_name" id="r_name">
			<label class="cleft_name ">我的昵称</label>
			<div class="fr ">
				<label class="name" id="nickname"></label>
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
		</div>
		<div class="cmn_name" id="my_ment">
			<label class="cleft_name">我的资料</label>
			<div class="fr" id="noRe">
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
		</div>

		<div class="cmn_name" id="r_gotoname">
			<label class="cleft_name">身份认证</label>

			<div class="fr">
				<img class="icon-sm" src="../../img/acount/realName.png">
			</div>
		</div>
		<div class="tips">
			<p class="tip">用户完成身份认证才可绑定支付宝和银行卡</p>
		</div>
		<div class="common_name" id="bdpay">
			<label class="cleft_name">我的支付宝</label>
			<div class="fr" id="nobind" style="display: block;">
				<label class="name"></label>
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
			<div class="fr" id="yes_bind" style="display: none;">
				<label class="name " id="alipay">已绑定</label>
			</div>
		</div>
		<div class="cmn_name" id="my_bankCard">
			<label class="cleft_name">我的银行卡</label>
			<div class="fr" id="nobank" style="display: block;">
				<label class="name"></label>
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
			<div class="fr" id="yesBank" style="display: none;">
				<label class="name " id="alipay">已绑定</label>
			</div>
		</div>
		<!--<div class="cmn_name" id="up_phone">
			<label class="cleft_name">修改手机号码</label>
			<div class="fr">
				<label class="name">去修改</label>
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
		</div>-->
		<div class="cmn_name" id="pay_pwd">
			<label class="cleft_name">管理支付密码</label>
			<div class="fr">
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
		</div>
		<div class="cmn_name  " id="forgot_pwd">
			<label class="cleft_name">找回支付密码</label>
			<div class="fr">
				<img src="../../img/default/right.png" class="rightimg" />
			</div>
		</div>
		<!--<div class="set_handpwd">
			<li class="mui-table-view-cell">
				<span>设置手势密码</span>
				<div class="mui-switch mui-switch-mini mui-active">
					<div class="mui-switch-handle"></div>
				</div>
			</li>
		</div>
		<div class="cmn_name" id="bdpay">
			<label class="cleft_name">修改手势密码</label>
			<div class="fr">
				<img src="../../../img/default/right.png" class="rightimg" />
			</div>
		</div>-->
		<button id="exit" class="btn_ext">退出登录</button>

	</body>

</html>