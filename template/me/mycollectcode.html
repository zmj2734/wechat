<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的收款码</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<style>
			body {
				background: #0098E6!important;
				height: 450px;
			}
		</style>
	</head>
	<script src="../../js/mui.min.js"></script>
	<script type="text/javascript" src="../../js/common.js"></script>
	<script type="text/javascript" src="../../js/jquery-3.1.0.min.js"></script>
	<script type="text/javascript">
		mui.init({
			swipeBack: true
		});
		var auid = null;
		auid = localStorage.getItem("auid");
		var bts = [];
		mui.plusReady(function() {
			var isLogin = null;
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {
				
					if(result.RESULTCODE == 0) {
							
						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							isLogin =0;
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						isLogin =0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {
						
						return;

					}
				});
				if(isLogin === 0){
					return;
				}

			//获取商家收款二维码
			mui.app_request("Post", {
				"OPERATE_TYPE": "10048",
				"AUTH_ID": auid, //localStorage.getItem("auid")
			}, function(result) {
				var img = booking.constants.ip + result.qr_cord_url;
				$("#code_image").attr("src", img);
				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					mui.toast(result.DESCRIPTION);
				} else {
					mui.toast("系统异常，请重试")
				}
			})

			//获取商铺折扣类型
			mui.app_request("Post", {
				"OPERATE_TYPE": "10049",
				"AUTH_ID": auid, //localStorage.getItem("auid")
			}, function(result) {
				$(".dis_name").html(result.voucher_type.grade)
				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					mui.toast(result.DESCRIPTION);
				} else {
					mui.toast("系统异常，请重试")
				}
			})

			mui.app_request("Post", {
				"OPERATE_TYPE": "10014",
				"AUTH_ID": auid, //localStorage.getItem("auid")
			}, function(result) {
				var html = '';

				for(var i = 0; i < result.RESULTLIST.result.length; i++) {
					var sData = result.RESULTLIST.result[i];
					if(sData.enable == "1") {
						html = '{title:"' + sData.grade + '",id:"' + sData.id + '",price:"' + sData.price + '"}'
						bts.push(html)
					}

				}
				bts = '[' + bts + ',]';
				bts = bts.replace(bts.substring(bts.lastIndexOf(',')), ']');
				bts = eval(bts)
				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					mui.toast(result.DESCRIPTION);
				} else {
					mui.toast("系统异常，请重试")
				}
			})

			document.getElementById("sale").addEventListener("tap", function() {
				plus.nativeUI.actionSheet({
						title: "请选择消费券档次",
						cancel: "取消",
						buttons: bts
					},
					function(e) {
						if(e.index == 0) {
							return;
						}
						var des = $('.dis_name').html();
						var num = bts[e.index - 1].price;
						num = parseInt(num);
						var tipHtml = '当前折扣将调整为' + num + '报100'
						mui.confirm(tipHtml, "", function(t) {

							if(t.index == 1) {
								$('.dis_name').html(bts[e.index - 1].title);
								var id = bts[e.index - 1].id;
								set_voucher_type(id);
							} else {
								$('.dis_name').html(des)
							}
						})

					}
				);
			})

		})

		//设置商铺折扣类型
		function set_voucher_type(id) {
			mui.app_request("Post", {
				"OPERATE_TYPE": "10050",
				"AUTH_ID": auid, //localStorage.getItem("auid")
				"VOUCHER_TYPE_ID": id,
			}, function(result) {
				mui.toast(result.DESCRIPTION);
				return;
			}, function(result) {
				if(result.RESULTCODE == "-1") {
					mui.toast(result.DESCRIPTION);
				} else {
					mui.toast("系统异常，请重试")
				}
			})
		}
	</script>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color"></a>
			<h1 class="mui-title">我的收款码</h1>
		</header>
		<div class="qrcode_img" style="margin-top: 150px;">
			<img src="../../img/mine/myqrcode.png" class="code_img" id="code_image" />
			<div class="check_dis" id="sale" style="display: none;">
				<p class="dis_name ">7折(30元档)</p>
				<img src="../../img/default/right.png " class="collect_img " />
			</div>
		</div>
	</body>

</html>