<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>登 录</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta http-equiv="Access-Control-Allow-Origin" content="*">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="../../css/app_new.css" />
		<script type="text/javascript" src="../../js/jquery-3.1.0.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" src="../../js/bank.js"></script>
		<style>
			.ul {
				margin-top: 0 !important;
			}
			
			.mui-content {
				height: 100%;
				position: relative;
			}
			
			.mt {
				margin-top: 11px;
			}
			
			.mui-input-row:after {
				left: 0 !important;
			}
			
			.mui-input-row label {
				padding-left: 0 !important;
			}
			
			.mui-input-row input {
				text-indent: 10px;
			}
			
			input {
				font-size: 15px;
			}
			
			.mui-input-row label~input {
				width: auto;
				flex: 1;
			}
			
			.mui-input-row {
				width: 100%;
				box-sizing: border-box;
				display: flex;
			}
		</style>
		<script>
			mui.init();
			var uuid = null;
			var auid = localStorage.getItem("auid");
			var checId = false;
			var win = null;
			var mobile = null;
			mui.plusReady(function() {
				var isLogin = null;
				mui.app_request("Post", {
					"OPERATE_TYPE": "10081",
					"AUTH_ID": localStorage.getItem("auid"),
				}, function(result) {

					if(result.RESULTCODE == 0) {

						if(result.RESULTLIST.is_login == 1) {

							return;
						} else {
							isLogin = 0;
							mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
								localStorage.removeItem("auid");
								booking.closeAndOpenNewWindow("../login/login.html", "login");
							});
							return;
						}
					}

				}, function(result) {
					if(result.RESULTCODE == -1) {
						isLogin = 0;
						mui.alert('您的账号已在其他设备登录，请重新登录。', '安全提示', function() {
							localStorage.removeItem("auid");
							booking.closeAndOpenNewWindow("../login/login.html", "login");
						});
						return;
					} else {

						return;

					}
				});
				if(isLogin === 0) {
					return;
				}
				win = plus.webview.currentWebview();
				document.getElementById("trueName").innerHTML = win.name;
				mui.app_request('POST', {
					"OPERATE_TYPE": "10023",
					"AUTH_ID": auid
				}, function(data) {
					if(data.RESULTCODE == "0") {
						mobile = data.RESULTLIST.my_base_info.username;
					}
					return;
				}, function(result) {
					mui.toast("系统异常，请重试");
				});

				document.getElementById("up_send").addEventListener("tap", function() {
					$("input").blur();
					var send = document.getElementById("up_send");
					booking.smsTime_new(send);
					mui.app_request('POST', {
						"OPERATE_TYPE": "10001",
						"MOBILE": mobile,
						"B_TYPE": "49"
					}, function(data) {
						if(data.RESULTCODE == "0") {
							uuid = data.RESULTLIST.UUID;
						}
						return;
					}, function(data) {
						if(data.RESULTCODE == "-1") {
							mui.toast(data.DESCRIPTION);
						} else {
							mui.toast("系统异常，请重试！");
						}
						return;
					});

				})

				//登录的点击事件 
				document.getElementById("login").addEventListener('tap', function() {
					setDisabled("login");
					$("input").blur();
					var account = document.getElementById("payAccount").value;
					var code = document.getElementById("code").value;
					var forBank = document.getElementById("forBank").value;

					if(mui.isnull(account)) {
						mui.toast("请输入银行卡号");
						remDisabled("login");
						return;
					}
					if(mui.isnull(forBank)) {
						mui.toast("请输入正确的银行卡号")
						remDisabled("login");
						return;
					}

					if(mui.isnull(code)) {
						mui.toast("验证码不能为空");
						remDisabled("login");
						return;
					}
					if(mui.isnull(uuid)) {
						mui.toast("请先发送验证码");
						remDisabled("login");
						return;
					}

					mui.app_request('POST', {
						"OPERATE_TYPE": "10087",
						"AUTH_ID": auid,
						"SMS_CODE": code,
						"ACCOUNT_NUM": account,
						"OPEN_BANK_NAME": forBank,
						"UUID": uuid
					}, function(data) {
						if(data.RESULTCODE == "0") {
							remDisabled("login");
							mui.toast("修改成功");
							uuid = null;
							booking.closeAndOpenNewWindow(
								'mine.html',
								'mine'
							)
						}

						remDisabled("login");
						return;
					}, function(data) {
						if(data.RESULTCODE == "-1") {
							mui.toast(data.DESCRIPTION);
						} else {
							mui.toast("系统异常，请重试！");
						}
						remDisabled("login");
						return;
					});
				});

			})

			function findBank() {
				var account = document.getElementById("payAccount").value;

			}

			function formatBankNo(BankNo) {
				if(BankNo.value == "") return;
				var account = new String(BankNo.value);

				account = account.substring(0, 30); /*账号的总数, 包括空格在内 */
				if(account.match(".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}") == null) {
					/* 对照格式 */
					if(account.match(".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}|" + ".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}|" +
							".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}|" + ".[0-9]{4}-[0-9]{4}-[0-9]{4}-[0-9]{7}") == null) {
						var accountNumeric = accountChar = "",
							i;
						for(i = 0; i < account.length; i++) {
							accountChar = account.substr(i, 1);
							if(!isNaN(accountChar) && (accountChar != " ")) accountNumeric = accountNumeric + accountChar;
						}
						account = "";
						for(i = 0; i < accountNumeric.length; i++) { /* 可将以下空格改为-,效果也不错 */
							if(i == 4) account = account + " "; /* 账号第四位数后加空格 */
							if(i == 8) account = account + " "; /* 账号第八位数后加空格 */
							if(i == 12) account = account + " "; /* 账号第十二位后数后加空格 */
							if(i == 16) account = account + " ";
							if(i == 20) account = account + " ";
							account = account + accountNumeric.substr(i, 1)
						}
					}
				} else {
					account = " " + account.substring(1, 5) + " " + account.substring(6, 10) + " " + account.substring(14, 18) + "-" + account.substring(18, 25);
				}
				//				var bank = testBank(account.replace(/\s/g, ""));
				//				document.getElementById("forBank").value = bank;
				if(account != BankNo.value) BankNo.value = account;
			}
		</script>
	</head>

	<body>
		<header id="header" class="mui-bar mui-bar-nav">
			<a class=" mui-action-back  mui-icon mui-icon-left-nav mui-pull-left color" id="back"></a>
			<h1 class="mui-title">修改银行卡</h1>
		</header>
		<div class="mui-content">
			<div class="ul">
				<ul class="input-row mui-input-group">
					<div class="mui-input-row">
						<label>收款账户名:</label>
						<label id="trueName"></label>
					</div>
					<div class="mui-input-row">
						<label>收款账号:</label>
						<input type="text" id="payAccount" oninput="formatBankNo(this)">
					</div>
					<div class="mui-input-row">
						<label>开户支行:</label>
						<input type="text" id="forBank" placeholder="请输入收款卡开户支行" />
					</div>
					<li>
						<input id="code" type="number" class="mui-input" autocomplete="off" maxlength="4" placeholder="请输入验证码" />
						<button id="up_send" type="button" class="send_code ">发送验证码</button>
					</li>
				</ul>
			</div>
			<button id="login" type="button" class="mui-btn mui-btn-success mui-btn-block">确认</button>
		</div>

	</body>

</html>